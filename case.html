<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CASES</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// localStorage polyfill for window.storage API
async function _stGet(key){try{const v=localStorage.getItem(key);return v!==null?{value:v}:null}catch{return null}}
async function _stSet(key,val){try{localStorage.setItem(key,val);return{key,value:val}}catch{return null}}

const { useState, useEffect, useRef, useCallback } = React;

const R={consumer:{label:"Consumer",color:"#b0b3b8",bg:"rgba(176,179,184,0.12)",chance:.55},industrial:{label:"Industrial",color:"#5b98d6",bg:"rgba(91,152,214,0.12)",chance:.20},milspec:{label:"Mil-Spec",color:"#4b69ff",bg:"rgba(75,105,255,0.12)",chance:.12},restricted:{label:"Restricted",color:"#8847ff",bg:"rgba(136,71,255,0.12)",chance:.06},classified:{label:"Classified",color:"#d32ce6",bg:"rgba(211,44,230,0.12)",chance:.03},covert:{label:"Covert",color:"#eb4b4b",bg:"rgba(235,75,75,0.12)",chance:.015},chroma:{label:"\u2605 Chroma",color:"#ffd700",bg:"rgba(255,215,0,0.18)",chance:.005}};
const RKEYS=Object.keys(R);
const IC={pistol:"\uD83D\uDD2B",knife:"\uD83D\uDD2A",rifle:"\uD83C\uDFF9",shield:"\uD83D\uDEE1\uFE0F",gem:"\uD83D\uDC8E",fire:"\uD83D\uDD25",bolt:"\u26A1",skull:"\uD83D\uDC80",star:"\u2B50",crown:"\uD83D\uDC51",sword:"\u2694\uFE0F",bomb:"\uD83D\uDCA3",crystal:"\uD83D\uDD2E",rocket:"\uD83D\uDE80",snake:"\uD83D\uDC0D",dragon:"\uD83D\uDC09",eye:"\uD83D\uDC41\uFE0F",rose:"\uD83C\uDF39",moon:"\uD83C\uDF19",comet:"\u2604\uFE0F",chain:"\u26D3\uFE0F",ring:"\uD83D\uDC8D",trophy:"\uD83C\uDFC6",wolf:"\uD83D\uDC3A",octopus:"\uD83D\uDC19",gear:"\u2699\uFE0F",anchor:"\u2693",leaf:"\uD83C\uDF43",tornado:"\uD83C\uDF2A\uFE0F",snowflake:"\u2744\uFE0F"};
const CONDITIONS=["Factory New","Minimal Wear","Field-Tested","Well-Worn","Battle-Scarred"];
const QUOTES_WIN=["Today is your day.","Not bad at all.","Someone's lucky.","The odds smiled on you.","Keep going.","That's a keeper.","Nice pull.","The grind pays off.","Clean.","Save it or sell it?"];
const QUOTES_LOSS=["I am so happy that I am not in your place.","Better luck next time.","The house always wins.","Pain.","That's rough.","F","It builds character.","Could be worse. Actually no.","Rent is due soon btw.","Your wallet felt that.","Ouch.","At least it's not real money.","Have you considered stopping?"];

const CASES=[
  {id:"scrap",name:"Scrap Box",price:30,color:"#78716c",icon:"\uD83D\uDDD1\uFE0F",items:[{name:"Rust Bucket",rarity:"consumer",value:3,icon:IC.gear},{name:"Tin Foil",rarity:"consumer",value:5,icon:IC.shield},{name:"Bent Nail",rarity:"consumer",value:8,icon:IC.chain},{name:"Duct Tape",rarity:"consumer",value:10,icon:IC.gear},{name:"Scrap Metal",rarity:"consumer",value:14,icon:IC.anchor},{name:"Copper Tube",rarity:"industrial",value:28,icon:IC.bolt},{name:"Old Spring",rarity:"industrial",value:38,icon:IC.gear},{name:"Silver Screw",rarity:"milspec",value:80,icon:IC.crystal},{name:"Brass Fitting",rarity:"restricted",value:180,icon:IC.gem},{name:"Gold Wire",rarity:"classified",value:450,icon:IC.ring},{name:"Platinum Shard",rarity:"covert",value:1200,icon:IC.gem},{name:"\u2605 Wrench",rarity:"chroma",value:4000,icon:IC.knife}]},
  {id:"worn",name:"Worn Case",price:75,color:"#6b7280",icon:"\uD83D\uDCE6",items:[{name:"Sand Dune",rarity:"consumer",value:8,icon:IC.pistol},{name:"Storm",rarity:"consumer",value:12,icon:IC.bolt},{name:"Mudder",rarity:"consumer",value:16,icon:IC.shield},{name:"Scorched",rarity:"consumer",value:22,icon:IC.fire},{name:"Predator",rarity:"industrial",value:45,icon:IC.skull},{name:"Blue Spruce",rarity:"industrial",value:60,icon:IC.crystal},{name:"Abyss",rarity:"milspec",value:130,icon:IC.eye},{name:"Oxide Blaze",rarity:"milspec",value:175,icon:IC.fire},{name:"Crimson Kimono",rarity:"restricted",value:340,icon:IC.rose},{name:"Night Stripe",rarity:"classified",value:780,icon:IC.moon},{name:"Slate",rarity:"covert",value:2000,icon:IC.gem},{name:"\u2605 Shadow Daggers",rarity:"chroma",value:7500,icon:IC.knife}]},
  {id:"militia",name:"Militia Case",price:120,color:"#65a30d",icon:"\uD83C\uDF92",items:[{name:"Dry Season",rarity:"consumer",value:12,icon:IC.leaf},{name:"Buckshot",rarity:"consumer",value:20,icon:IC.bomb},{name:"Warbird",rarity:"consumer",value:28,icon:IC.shield},{name:"Copperhead",rarity:"consumer",value:34,icon:IC.snake},{name:"Mako",rarity:"industrial",value:70,icon:IC.bolt},{name:"Jackal",rarity:"industrial",value:95,icon:IC.wolf},{name:"Rattler",rarity:"milspec",value:210,icon:IC.snake},{name:"Torque",rarity:"milspec",value:280,icon:IC.chain},{name:"Basilisk",rarity:"restricted",value:580,icon:IC.eye},{name:"Nightfall",rarity:"classified",value:1300,icon:IC.moon},{name:"Venom Strike",rarity:"covert",value:3200,icon:IC.snake},{name:"\u2605 Gut Knife",rarity:"chroma",value:11000,icon:IC.knife}]},
  {id:"standard",name:"Armory Case",price:250,color:"#3b82f6",icon:"\uD83E\uDDF0",items:[{name:"Groundwater",rarity:"consumer",value:25,icon:IC.pistol},{name:"Shag",rarity:"consumer",value:38,icon:IC.shield},{name:"Urban DDPAT",rarity:"consumer",value:45,icon:IC.rifle},{name:"Stained",rarity:"industrial",value:85,icon:IC.knife},{name:"Brass",rarity:"industrial",value:125,icon:IC.bolt},{name:"Cobalt Halftone",rarity:"milspec",value:320,icon:IC.crystal},{name:"Pulse",rarity:"milspec",value:420,icon:IC.bolt},{name:"Asiimov",rarity:"restricted",value:950,icon:IC.rocket},{name:"Hyperbeast",rarity:"classified",value:2300,icon:IC.dragon},{name:"Dragon Lore",rarity:"covert",value:6500,icon:IC.dragon},{name:"\u2605 Butterfly Knife",rarity:"chroma",value:28000,icon:IC.knife}]},
  {id:"hazard",name:"Hazard Case",price:400,color:"#f97316",icon:"\u2622\uFE0F",items:[{name:"Reactor",rarity:"consumer",value:42,icon:IC.bolt},{name:"Fallout",rarity:"consumer",value:58,icon:IC.bomb},{name:"Toxin",rarity:"consumer",value:68,icon:IC.skull},{name:"Meltdown",rarity:"industrial",value:140,icon:IC.fire},{name:"Corroded",rarity:"industrial",value:190,icon:IC.chain},{name:"Radiant",rarity:"milspec",value:420,icon:IC.crystal},{name:"Isotope",rarity:"milspec",value:580,icon:IC.gem},{name:"Biohazard",rarity:"restricted",value:1500,icon:IC.skull},{name:"Chernobyl",rarity:"classified",value:3400,icon:IC.fire},{name:"Plutonium",rarity:"covert",value:11000,icon:IC.comet},{name:"\u2605 Bayonet Tiger Tooth",rarity:"chroma",value:38000,icon:IC.knife}]},
  {id:"frost",name:"Frost Case",price:500,color:"#67e8f9",icon:"\u2744\uFE0F",items:[{name:"Icicle",rarity:"consumer",value:50,icon:IC.snowflake},{name:"Permafrost",rarity:"consumer",value:65,icon:IC.snowflake},{name:"Glacier",rarity:"consumer",value:80,icon:IC.crystal},{name:"Avalanche",rarity:"industrial",value:160,icon:IC.tornado},{name:"Tundra",rarity:"industrial",value:220,icon:IC.snowflake},{name:"Frostbite",rarity:"milspec",value:480,icon:IC.skull},{name:"Ice Queen",rarity:"milspec",value:650,icon:IC.crown},{name:"Blizzard",rarity:"restricted",value:1700,icon:IC.tornado},{name:"Absolute Zero",rarity:"classified",value:4000,icon:IC.crystal},{name:"Sub-Zero",rarity:"covert",value:13000,icon:IC.gem},{name:"\u2605 Huntsman Knife Ice",rarity:"chroma",value:45000,icon:IC.knife}]},
  {id:"prisma",name:"Prisma Case",price:700,color:"#8b5cf6",icon:"\uD83D\uDD6E",items:[{name:"Candy Apple",rarity:"consumer",value:55,icon:IC.pistol},{name:"Ossuary",rarity:"consumer",value:75,icon:IC.skull},{name:"Pole Position",rarity:"industrial",value:160,icon:IC.rocket},{name:"Tigris",rarity:"industrial",value:220,icon:IC.eye},{name:"Neon Rider",rarity:"milspec",value:520,icon:IC.bolt},{name:"Bloodsport",rarity:"milspec",value:740,icon:IC.fire},{name:"Phantom Disruptor",rarity:"restricted",value:1900,icon:IC.crystal},{name:"Printstream",rarity:"classified",value:4800,icon:IC.gem},{name:"Wild Lotus",rarity:"covert",value:16000,icon:IC.rose},{name:"\u2605 Karambit Fade",rarity:"chroma",value:65000,icon:IC.knife}]},
  {id:"shadow",name:"Shadow Case",price:1200,color:"#334155",icon:"\uD83C\uDF11",items:[{name:"Eclipse",rarity:"consumer",value:90,icon:IC.moon},{name:"Umbra",rarity:"consumer",value:120,icon:IC.eye},{name:"Wraith",rarity:"consumer",value:150,icon:IC.skull},{name:"Phantom",rarity:"industrial",value:300,icon:IC.crystal},{name:"Shade",rarity:"industrial",value:400,icon:IC.moon},{name:"Reaper",rarity:"milspec",value:850,icon:IC.skull},{name:"Void Walker",rarity:"milspec",value:1150,icon:IC.eye},{name:"Oblivion",rarity:"restricted",value:3200,icon:IC.comet},{name:"Abyss Lord",rarity:"classified",value:8500,icon:IC.dragon},{name:"Nyx",rarity:"covert",value:28000,icon:IC.crown},{name:"\u2605 Flip Knife Marble Fade",rarity:"chroma",value:85000,icon:IC.knife}]},
  {id:"deep",name:"Deep Sea Case",price:1600,color:"#0e7490",icon:"\uD83C\uDF0A",items:[{name:"Barnacle",rarity:"consumer",value:110,icon:IC.anchor},{name:"Kelp",rarity:"consumer",value:150,icon:IC.leaf},{name:"Coral",rarity:"consumer",value:190,icon:IC.rose},{name:"Anglerfish",rarity:"industrial",value:400,icon:IC.eye},{name:"Trident",rarity:"industrial",value:550,icon:IC.sword},{name:"Kraken",rarity:"milspec",value:1100,icon:IC.octopus},{name:"Leviathan",rarity:"milspec",value:1500,icon:IC.dragon},{name:"Maelstrom",rarity:"restricted",value:4200,icon:IC.tornado},{name:"Abyss Pearl",rarity:"classified",value:11000,icon:IC.gem},{name:"Poseidon",rarity:"covert",value:35000,icon:IC.crown},{name:"\u2605 Talon Knife Sapphire",rarity:"chroma",value:100000,icon:IC.knife}]},
  {id:"elite",name:"Classified Case",price:2500,color:"#ef4444",icon:"\uD83D\uDCBC",items:[{name:"Chalice",rarity:"consumer",value:160,icon:IC.gem},{name:"Blaze",rarity:"consumer",value:220,icon:IC.fire},{name:"Whiteout",rarity:"industrial",value:500,icon:IC.crystal},{name:"X-Ray",rarity:"industrial",value:700,icon:IC.eye},{name:"Fever Dream",rarity:"milspec",value:1400,icon:IC.rose},{name:"Neo-Noir",rarity:"milspec",value:1800,icon:IC.moon},{name:"Vulcan",rarity:"restricted",value:4500,icon:IC.bolt},{name:"Fire Serpent",rarity:"classified",value:14000,icon:IC.snake},{name:"Howl",rarity:"covert",value:45000,icon:IC.dragon},{name:"\u2605 M9 Crimson Web",rarity:"chroma",value:160000,icon:IC.knife}]},
  {id:"titan",name:"Titan Case",price:5000,color:"#fbbf24",icon:"\uD83C\uDFC6",items:[{name:"Gilded",rarity:"consumer",value:350,icon:IC.crown},{name:"Overture",rarity:"consumer",value:500,icon:IC.star},{name:"Monolith",rarity:"consumer",value:650,icon:IC.shield},{name:"Sovereign",rarity:"industrial",value:1400,icon:IC.ring},{name:"Titan Bore",rarity:"industrial",value:2000,icon:IC.rocket},{name:"Mjolnir",rarity:"milspec",value:4500,icon:IC.bolt},{name:"Excalibur",rarity:"milspec",value:6500,icon:IC.sword},{name:"Godslayer",rarity:"restricted",value:16000,icon:IC.skull},{name:"Ragnarok",rarity:"classified",value:45000,icon:IC.comet},{name:"Infinity",rarity:"covert",value:130000,icon:IC.star},{name:"\u2605 Karambit Sapphire",rarity:"chroma",value:500000,icon:IC.knife}]},
  {id:"void",name:"Void Case",price:10000,color:"#7c3aed",icon:"\uD83C\uDF0C",items:[{name:"Dark Matter",rarity:"consumer",value:600,icon:IC.crystal},{name:"Singularity",rarity:"consumer",value:850,icon:IC.eye},{name:"Event Horizon",rarity:"consumer",value:1100,icon:IC.comet},{name:"Neutron Star",rarity:"industrial",value:2500,icon:IC.star},{name:"Quasar",rarity:"industrial",value:3800,icon:IC.bolt},{name:"Pulsar",rarity:"milspec",value:8000,icon:IC.bolt},{name:"Nebula Core",rarity:"milspec",value:12000,icon:IC.crystal},{name:"Supernova",rarity:"restricted",value:30000,icon:IC.fire},{name:"Black Hole",rarity:"classified",value:80000,icon:IC.skull},{name:"Big Bang",rarity:"covert",value:250000,icon:IC.comet},{name:"\u2605 Skeleton Knife Ruby",rarity:"chroma",value:1000000,icon:IC.knife}]}
];

const DEFAULT_BAL=1000,RENT_EVERY=5,RENT_AMT=200,MAX_LOAN=5000,LOAN_RATE=.2,SCROLL_COUNT=55,WIN_IDX=48;
const INIT={bal:DEFAULT_BAL,inv:[],stats:{opened:0,spent:0,won:0,sold:0,best:null,bestVal:0},loan:0,rentCtr:0,history:[{n:0,bal:DEFAULT_BAL,label:"Start"}],starred:{}};
function roll(c){let r2=Math.random(),cum=0;for(const[k,v]of Object.entries(R)){cum+=v.chance;if(r2<=cum){const pool=c.items.filter(i=>i.rarity===k);if(pool.length)return pool[Math.floor(Math.random()*pool.length)]}}return c.items.filter(i=>i.rarity==="consumer")[0]}
function money(n){return"$"+n.toLocaleString()}
function genFloat(){return Math.random()}
function getCondition(f){if(f<.07)return CONDITIONS[0];if(f<.15)return CONDITIONS[1];if(f<.38)return CONDITIONS[2];if(f<.45)return CONDITIONS[3];return CONDITIONS[4]}
function condAbbr(c){return c.split(" ").map(w=>w[0]).join("")}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
const TAB_ID=uid();

// Sound system using Web Audio API
let _actx;function actx(){if(!_actx)_actx=new(window.AudioContext||window.webkitAudioContext)();return _actx}
function playTone(freq,dur,type="sine",vol=0.15){try{const c=actx(),o=c.createOscillator(),g=c.createGain();o.type=type;o.frequency.value=freq;g.gain.value=vol;g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+dur);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+dur)}catch{}}
function sndOpen(){playTone(440,.08,"square",.1);setTimeout(()=>playTone(660,.08,"square",.1),60)}
function sndReveal(isWin){if(isWin){playTone(523,.1,"sine",.12);setTimeout(()=>playTone(659,.1,"sine",.12),80);setTimeout(()=>playTone(784,.15,"sine",.14),160)}else{playTone(330,.15,"triangle",.1);setTimeout(()=>playTone(260,.2,"triangle",.08),120)}}
function sndSell(){playTone(880,.06,"square",.08);setTimeout(()=>playTone(1100,.06,"square",.08),50)}

function Starburst({color,children}){const pts=18,outer=50,inner=42;let d="";for(let i=0;i<pts*2;i++){const a=(Math.PI*i)/pts-Math.PI/2,r=i%2===0?outer:inner;d+=(i===0?"M":"L")+(50+r*Math.cos(a))+","+(50+r*Math.sin(a))}d+="Z";return(<div style={{position:"relative",width:"clamp(120px,35vw,200px)",height:"clamp(120px,35vw,200px)"}}><svg viewBox="0 0 100 100" style={{position:"absolute",inset:0,width:"100%",height:"100%",filter:`drop-shadow(0 0 12px ${color}44)`}}><path d={d} fill={color+"22"} stroke={color} strokeWidth="0.5"/></svg><div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center"}}>{children}</div></div>)}

function App(){
  const[slot,setSlot]=useState(0);const[slotMeta,setSlotMeta]=useState([null,null,null]);const[showSlots,setShowSlots]=useState(true);
  const[st,setSt]=useState(INIT);const[page,setPage]=useState("shop");const[selCase,setSelCase]=useState(null);const[wonItem,setWonItem]=useState(null);const[wonFloat,setWonFloat]=useState(0);const[wonQuote,setWonQuote]=useState("");const[scrollItems,setScrollItems]=useState([]);const[scrollDone,setScrollDone]=useState(false);const[opening,setOpening]=useState(false);const[resetMsg,setResetMsg]=useState("");const[loanAmt,setLoanAmt]=useState("");const[rentPaid,setRentPaid]=useState(0);const[inspecting,setInspecting]=useState(null);const[confirmReset,setConfirmReset]=useState(false);const[drops,setDrops]=useState([]);
  const[invSort,setInvSort]=useState("newest");const[invFilter,setInvFilter]=useState("all");const[invView,setInvView]=useState("grid");const[selItem,setSelItem]=useState(null);const[sellAmt,setSellAmt]=useState("");const[sellConfirm,setSellConfirm]=useState(null);const[lastWonId,setLastWonId]=useState(null);
  const stripRef=useRef(null);const lockRef=useRef(false);

  useEffect(()=>{(async()=>{try{const r=await _stGet("co-slots");if(r?.value)setSlotMeta(JSON.parse(r.value))}catch{}})()},[]);
  async function saveSlotMeta(m){setSlotMeta(m);try{await _stSet("co-slots",JSON.stringify(m))}catch{}}
  async function loadSlot(i){
    // Claim slot lock
    try{await _stSet("co-lock-"+i,TAB_ID)}catch{}
    setSlot(i);setShowSlots(false);try{const r=await _stGet("co-s"+i);if(r?.value){const d=JSON.parse(r.value);setSt(s=>({...INIT,...d.st,starred:d.st?.starred||{}}));if(d.drops)setDrops(d.drops)}else{setSt({...INIT,inv:[],stats:{...INIT.stats},history:[{n:0,bal:DEFAULT_BAL,label:"Start"}],starred:{}});setDrops([])}}catch{setSt({...INIT});setDrops([])}setPage("shop");setOpening(false);lockRef.current=false}

  // Check tab lock - if another tab stole our slot, go back to slot screen
  useEffect(()=>{if(showSlots)return;const id=setInterval(async()=>{try{const r=await _stGet("co-lock-"+slot);if(r?.value&&r.value!==TAB_ID){setShowSlots(true);setOpening(false);lockRef.current=false}}catch{}},2000);return()=>clearInterval(id)},[showSlots,slot]);

  const save=useCallback(async(s,d)=>{try{const lk=await _stGet("co-lock-"+slot);if(lk?.value&&lk.value!==TAB_ID)return;await _stSet("co-s"+slot,JSON.stringify({st:s,drops:d||[]}))}catch{}const inv=s.inv||[];const tv=inv.reduce((a,i)=>a+i.value,0);setSlotMeta(prev=>{const m=[...prev];m[slot]={bal:s.bal,items:inv.length,totalVal:tv,opened:s.stats?.opened||0};saveSlotMeta(m);return m})},[slot]);
  useEffect(()=>{if(showSlots)return;const id=setInterval(()=>{setSt(cur=>{setDrops(dd=>{save(cur,dd);return dd});return cur})},5000);return()=>clearInterval(id)},[save,showSlots]);

  function checkReset(s){const cheapest=Math.min(...CASES.map(c=>c.price));if(s.bal<cheapest&&s.loan>=MAX_LOAN){setResetMsg("Bankrupt. Game reset.");const fresh={...INIT,inv:[],stats:{...INIT.stats},history:[{n:0,bal:DEFAULT_BAL,label:"Start"}],starred:{}};setSt(fresh);setDrops([]);save(fresh,[]);setTimeout(()=>{setResetMsg("");setPage("shop")},2500);return true}return false}

  function doOpen(c){
    if(lockRef.current||st.bal<c.price)return;lockRef.current=true;setOpening(true);setScrollDone(false);setSelCase(c);sndOpen();
    const winner=roll(c),fl=genFloat(),quotes=winner.value>=c.price?QUOTES_WIN:QUOTES_LOSS;
    setWonItem({...winner,id:uid()});setWonFloat(fl);setWonQuote(quotes[Math.floor(Math.random()*quotes.length)]);
    const items=[];for(let i=0;i<SCROLL_COUNT;i++)items.push(i===WIN_IDX?winner:c.items[Math.floor(Math.random()*c.items.length)]);
    setScrollItems(items);setPage("opening");
    setSt(p=>{const ns={...p,bal:p.bal-c.price,stats:{...p.stats,spent:p.stats.spent+c.price,opened:p.stats.opened+1}};save(ns,drops);return ns});
    requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!stripRef.current)return;const el=stripRef.current,parent=el.parentElement;el.style.transition="none";el.style.transform="translateX(0)";requestAnimationFrame(()=>{if(!stripRef.current)return;const itemW=parent.offsetWidth*.16,center=parent.offsetWidth/2,off=WIN_IDX*itemW+itemW/2-center+(Math.random()-.5)*itemW*.6;el.style.transition="transform 5s cubic-bezier(0.15,0.85,0.20,1.01)";el.style.transform=`translateX(-${off}px)`})})});
    setTimeout(()=>{setScrollDone(true);sndReveal(winner.value>=c.price);let rp=0;setSt(prev=>{let rc=prev.rentCtr+1;if(rc>=RENT_EVERY){rp=RENT_AMT;rc=0}setRentPaid(rp);const newBal=prev.bal-rp;const isBig=winner.value>=c.price*3;const he={n:prev.stats.opened,bal:newBal};if(isBig)he.label=winner.name+" "+money(winner.value);const itemId=uid();setLastWonId(itemId);const ns={...prev,bal:newBal,inv:[...prev.inv,{...winner,id:itemId,from:c.id,t:Date.now(),float:fl}],stats:{...prev.stats,won:prev.stats.won+winner.value,best:winner.value>prev.stats.bestVal?winner.name:prev.stats.best,bestVal:Math.max(prev.stats.bestVal,winner.value)},loan:prev.loan,rentCtr:rc,history:[...(prev.history||[]),he].slice(-200),starred:prev.starred||{}};const nd={name:winner.name,rarity:winner.rarity,value:winner.value,cond:getCondition(fl),icon:winner.icon};setDrops(dd=>{const r=[nd,...dd].slice(0,20);save(ns,r);return r});setTimeout(()=>{checkReset(ns);lockRef.current=false},400);return ns})},5400);
  }

  function openAgain(){setLastWonId(null);if(!selCase||st.bal<selCase.price){setPage("shop");setOpening(false);return}doOpen(selCase)}
  function borrow(){const a=parseInt(loanAmt);if(!a||a<=0)return;const actual=Math.min(a,MAX_LOAN-st.loan);if(actual<=0)return;setSt(p=>{const ns={...p,bal:p.bal+actual,loan:p.loan+Math.round(actual*(1+LOAN_RATE))};save(ns,drops);return ns});setLoanAmt("")}
  function repay(){const a=parseInt(loanAmt);if(!a||a<=0)return;const actual=Math.min(a,st.loan,st.bal);if(actual<=0)return;setSt(p=>{const ns={...p,bal:p.bal-actual,loan:p.loan-actual};save(ns,drops);return ns});setLoanAmt("")}
  function doReset(){const fresh={...INIT,inv:[],stats:{...INIT.stats},history:[{n:0,bal:DEFAULT_BAL,label:"Start"}],starred:{}};setSt(fresh);setDrops([]);save(fresh,[]);setPage("shop");lockRef.current=false;setOpening(false);setConfirmReset(false)}

  function sellItem(item){sndSell();setSt(p=>{const idx=p.inv.findIndex(i=>i.id===item.id);if(idx===-1)return p;const ni=[...p.inv];ni.splice(idx,1);const starred={...p.starred};delete starred[item.id];const ns={...p,bal:p.bal+item.value,inv:ni,stats:{...p.stats,sold:(p.stats.sold||0)+item.value},starred};save(ns,drops);return ns});setSelItem(null)}
  function sellLastWon(){if(!lastWonId||!wonItem)return;sndSell();setSt(p=>{const idx=p.inv.findIndex(i=>i.id===lastWonId);if(idx===-1)return p;const item=p.inv[idx];const ni=[...p.inv];ni.splice(idx,1);const starred={...p.starred};delete starred[lastWonId];const ns={...p,bal:p.bal+item.value,inv:ni,stats:{...p.stats,sold:(p.stats.sold||0)+item.value},starred};save(ns,drops);return ns});setLastWonId(null)}
  function sellMultiple(count){sndSell();setSt(p=>{let sorted=getFilteredSorted(p.inv,p.starred);sorted=sorted.filter(i=>!p.starred[i.id]);const toSell=sorted.slice(0,count);if(!toSell.length)return p;const ids=new Set(toSell.map(i=>i.id));const total=toSell.reduce((s,i)=>s+i.value,0);const ni=p.inv.filter(i=>!ids.has(i.id));const ns={...p,bal:p.bal+total,inv:ni,stats:{...p.stats,sold:(p.stats.sold||0)+total}};save(ns,drops);return ns})}
  function sellAllUnstarred(){sndSell();setSt(p=>{const unstarred=p.inv.filter(i=>!p.starred[i.id]);if(!unstarred.length)return p;const total=unstarred.reduce((s,i)=>s+i.value,0);const starred=p.inv.filter(i=>p.starred[i.id]);const ns={...p,bal:p.bal+total,inv:starred,stats:{...p.stats,sold:(p.stats.sold||0)+total}};save(ns,drops);return ns});setSellConfirm(null)}
  function toggleStar(id){setSt(p=>{const s={...p.starred};if(s[id])delete s[id];else s[id]=true;const ns={...p,starred:s};save(ns,drops);return ns})}

  function getFilteredSorted(inv,starred){let items=[...inv];if(invFilter==="starred")items=items.filter(i=>starred[i.id]);else if(invFilter!=="all")items=items.filter(i=>i.rarity===invFilter);if(invSort==="newest")items.reverse();else if(invSort==="value-high")items.sort((a,b)=>b.value-a.value);else if(invSort==="value-low")items.sort((a,b)=>a.value-b.value);else if(invSort==="rarity")items.sort((a,b)=>RKEYS.indexOf(b.rarity)-RKEYS.indexOf(a.rarity));else if(invSort==="name")items.sort((a,b)=>a.name.localeCompare(b.name));return items}

  const rentIn=RENT_EVERY-st.rentCtr,invTotal=st.inv.reduce((s,i)=>s+i.value,0),profit=(st.stats.sold||0)+invTotal-st.stats.spent,unstarredCount=st.inv.filter(i=>!st.starred?.[i.id]).length,unstarredVal=st.inv.filter(i=>!st.starred?.[i.id]).reduce((s,i)=>s+i.value,0);
  function caseStats(cId){const items=st.inv.filter(i=>i.from===cId);const sp=items.length*(CASES.find(c=>c.id===cId)?.price||0);const ea=items.reduce((s,i)=>s+i.value,0);const counts={};RKEYS.forEach(k=>{counts[k]=items.filter(i=>i.rarity===k).length});return{opened:items.length,spent:sp,earned:ea,counts}}
  const filteredInv=getFilteredSorted(st.inv,st.starred||{});

  // SAVE SLOT SCREEN
  if(showSlots)return(<div style={S.root}><style>{CSS}</style><div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"clamp(20px,5vw,40px)",gap:"clamp(16px,4vw,28px)"}}><div style={{fontSize:"clamp(20px,6vw,32px)",fontWeight:800,letterSpacing:3,color:"#ccc"}}>CASES</div><div style={{color:"#666",fontSize:"clamp(10px,2.5vw,13px)"}}>Select a save slot</div><div style={{display:"flex",flexDirection:"column",gap:"clamp(8px,2vw,12px)",width:"100%",maxWidth:400}}>{[0,1,2].map(i=>{const m=slotMeta[i];return(<button key={i} onClick={()=>loadSlot(i)} style={{...S.slotBtn,borderColor:slot===i?"#4ade80":"#1e2430"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"}}><span style={{fontWeight:700,fontSize:"clamp(12px,3vw,16px)"}}>Slot {i+1}</span>{m?<span style={{color:"#4ade80",fontWeight:600,fontSize:"clamp(10px,2.5vw,13px)"}}>{money(m.bal)}</span>:<span style={{color:"#555",fontSize:"clamp(10px,2.5vw,12px)"}}>Empty</span>}</div>{m&&<div style={{display:"flex",gap:"clamp(10px,3vw,18px)",fontSize:"clamp(8px,2vw,10px)",color:"#888"}}><span>{m.items} items</span><span>Inv: {money(m.totalVal)}</span><span>{m.opened} opened</span></div>}</button>)})}</div></div></div>);

  return(<div style={S.root}><style>{CSS}</style>

    {/* Modals */}
    {confirmReset&&<div style={S.overlay}><div style={S.modal}><div style={{fontSize:"clamp(28px,8vw,44px)"}}>{"\u26A0\uFE0F"}</div><div style={{fontSize:"clamp(14px,3.5vw,18px)",fontWeight:700}}>Reset slot {slot+1}?</div><div style={{color:"#888",fontSize:"clamp(10px,2.5vw,12px)",textAlign:"center"}}>Everything will be wiped.</div><div style={{display:"flex",gap:"clamp(8px,2vw,12px)",marginTop:8}}><button onClick={()=>setConfirmReset(false)} style={{...S.btn,background:"#ffffff0a",color:"#888",flex:1}}>Cancel</button><button onClick={doReset} style={{...S.btn,background:"#eb4b4b",color:"#fff",flex:1}}>Reset</button></div></div></div>}

    {sellConfirm&&<div style={S.overlay}><div style={S.modal}><div style={{fontSize:"clamp(14px,3.5vw,18px)",fontWeight:700}}>Sell {sellConfirm==="all"?`${unstarredCount} unstarred`:`${sellAmt} cheapest`} items?</div><div style={{color:"#4ade80",fontSize:"clamp(14px,3.5vw,20px)",fontWeight:700}}>+{money(sellConfirm==="all"?unstarredVal:0)}</div><div style={{color:"#f59e0b",fontSize:"clamp(9px,2.2vw,11px)"}}>Starred items are protected</div><div style={{display:"flex",gap:8}}><button onClick={()=>setSellConfirm(null)} style={{...S.btn,background:"#ffffff0a",color:"#888",flex:1}}>Cancel</button><button onClick={()=>{if(sellConfirm==="all")sellAllUnstarred();else sellMultiple(parseInt(sellAmt)||1);setSellConfirm(null)}} style={{...S.btn,background:"#4ade80",color:"#000",flex:1}}>Sell</button></div></div></div>}

    {selItem&&<div style={S.overlay} onClick={()=>setSelItem(null)}><div style={S.modal} onClick={e=>e.stopPropagation()}><div style={{fontSize:"clamp(40px,12vw,64px)"}}>{selItem.icon}</div><div style={{color:R[selItem.rarity]?.color,fontSize:"clamp(9px,2.2vw,11px)",fontWeight:700,letterSpacing:2,textTransform:"uppercase"}}>{R[selItem.rarity]?.label}</div><div style={{fontSize:"clamp(16px,4.5vw,22px)",fontWeight:700,textAlign:"center"}}>{selItem.name}</div><div style={{fontSize:"clamp(20px,5.5vw,28px)",fontWeight:800,color:"#4ade80"}}>{money(selItem.value)}</div>
      {selItem.float!==undefined&&<><div style={{color:"#ccc",fontSize:"clamp(11px,2.8vw,14px)",fontWeight:600}}>{getCondition(selItem.float)}</div><div style={{width:"100%"}}><div style={{display:"flex",justifyContent:"space-between",fontSize:"clamp(7px,1.8vw,9px)",color:"#666",marginBottom:2}}><span>0.00</span><span>1.00</span></div><div style={{position:"relative",height:6,borderRadius:4,overflow:"hidden",background:"linear-gradient(to right,#4ade80,#4ade80 7%,#a3e635 7%,#a3e635 15%,#fbbf24 15%,#fbbf24 38%,#f97316 38%,#f97316 45%,#ef4444 45%)"}}><div style={{position:"absolute",top:-2,bottom:-2,left:`${selItem.float*100}%`,width:2,background:"#fff",borderRadius:1,boxShadow:"0 0 4px #fff"}}/></div><div style={{textAlign:"center",color:"#888",fontSize:"clamp(8px,2vw,10px)",marginTop:3}}>Float: {selItem.float.toFixed(4)}</div></div></>}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"clamp(4px,1vw,8px)",width:"100%",fontSize:"clamp(8px,2vw,10px)",color:"#888"}}><div>From: {CASES.find(c=>c.id===selItem.from)?.name||"?"}</div><div>ID: {selItem.id?.slice(0,8)}</div><div>Dropped: {selItem.t?new Date(selItem.t).toLocaleDateString():"-"}</div><div>Rarity: {(R[selItem.rarity]?.chance*100).toFixed(1)}%</div></div>
      <div style={{display:"flex",gap:6,width:"100%",marginTop:4}}><button onClick={()=>toggleStar(selItem.id)} style={{...S.btn,background:st.starred?.[selItem.id]?"#ffd70022":"#ffffff08",color:st.starred?.[selItem.id]?"#ffd700":"#888",flex:1,border:st.starred?.[selItem.id]?"1px solid #ffd70044":"1px solid transparent"}}>{st.starred?.[selItem.id]?"\u2605 Starred":"\u2606 Star"}</button><button onClick={()=>sellItem(selItem)} disabled={!!st.starred?.[selItem.id]} style={{...S.btn,background:st.starred?.[selItem.id]?"#333":"#4ade80",color:st.starred?.[selItem.id]?"#666":"#000",flex:1}}>Sell {money(selItem.value)}</button></div>
      <button onClick={()=>setSelItem(null)} style={{...S.btn,background:"#ffffff08",color:"#666",width:"100%"}}>Close</button>
    </div></div>}

    {resetMsg&&<div style={S.overlay}><div style={S.modal}><div style={{fontSize:"clamp(36px,10vw,56px)"}}>{"\uD83D\uDC80"}</div><div style={{fontSize:"clamp(16px,4vw,22px)",fontWeight:700,color:"#eb4b4b"}}>{resetMsg}</div></div></div>}

    {/* HEADER */}
    <div style={S.hdr}><div style={{display:"flex",alignItems:"center",gap:"clamp(6px,1.5vw,10px)"}}><button onClick={()=>setShowSlots(true)} style={{...S.btn,background:"#ffffff08",color:"#888",padding:"clamp(4px,1vw,6px) clamp(6px,1.5vw,10px)",fontSize:"clamp(9px,2.2vw,11px)"}}>Slot {slot+1}</button><div style={S.title}>CASES</div></div><div style={S.hdrRight}><div style={S.chip}><span style={S.chipLbl}>BAL</span><span style={{color:st.bal<100?"#eb4b4b":"#4ade80",fontWeight:700,fontSize:"clamp(14px,3.5vw,20px)"}}>{money(st.bal)}</span></div>{st.loan>0&&<div style={{...S.chip,borderColor:"#eb4b4b33"}}><span style={S.chipLbl}>DEBT</span><span style={{color:"#eb4b4b",fontWeight:700,fontSize:"clamp(12px,3vw,18px)"}}>{money(st.loan)}</span></div>}<div style={S.rentChip}>Rent in {rentIn}</div></div></div>

    {/* NAV */}
    <div style={S.nav}>{[["shop","Shop"],["inv",`Inv (${st.inv.length})`],["stats","Stats"],["loan","Loan"]].map(([k,l])=>(<button key={k} onClick={()=>{if(!opening||k==="shop")setPage(k)}} style={{...S.tab,...(page===k||(page==="opening"&&k==="shop")?S.tabOn:{})}}>{l}</button>))}<button onClick={()=>setConfirmReset(true)} style={{...S.tab,marginLeft:"auto",color:"#eb4b4b"}}>Reset</button></div>

    {/* SHOP */}
    {page==="shop"&&<div style={S.body}><div style={S.grid}>{CASES.map(c=>{const ok=st.bal>=c.price;return(<div key={c.id} style={{...S.card,borderColor:c.color+"44",opacity:ok?1:.35}}><div style={{...S.cardIcon,background:c.color+"12",borderColor:c.color+"28"}}><span style={{fontSize:"clamp(26px,6.5vw,40px)"}}>{c.icon}</span></div><div style={S.cardName}>{c.name}</div><div style={{...S.cardPrice,color:c.color}}>{money(c.price)}</div><div style={{display:"flex",gap:"clamp(4px,1vw,6px)",width:"100%"}}><button disabled={!ok} onClick={()=>doOpen(c)} style={{...S.btn,background:ok?c.color:"#333",color:"#fff",flex:1}}>Open</button><button onClick={()=>{setInspecting(c);setPage("inspect")}} style={{...S.btn,background:"#ffffff08",color:"#777",flex:1}}>Inspect</button></div></div>)})}</div></div>}

    {/* OPENING */}
    {page==="opening"&&<div style={S.body}>
      <div style={{textAlign:"center",padding:"clamp(6px,1.5vw,10px) 0",color:"#555",fontSize:"clamp(10px,2.5vw,13px)"}}>{scrollDone?"":"Opening "+selCase?.name+"..."}</div>
      <div style={S.scrollOuter}><div style={S.marker}/><div style={S.scrollClip}><div ref={stripRef} style={S.strip}>{scrollItems.map((item,i)=>{const rar=R[item.rarity];const won=i===WIN_IDX&&scrollDone;return(<div key={i} style={{...S.sItem,borderBottomColor:rar.color,background:won?rar.bg:"#0c0e13",transform:won?"scale(1.06)":"none",zIndex:won?2:0}}><div style={{fontSize:"clamp(16px,4vw,28px)",lineHeight:1}}>{item.rarity==="chroma"?<span style={{color:"#ffd700",textShadow:"0 0 8px #ffd70066"}}>?</span>:<span>{item.icon||"?"}</span>}</div><div style={{fontSize:"clamp(6px,1.6vw,9px)",color:rar.color,fontWeight:600,textAlign:"center",lineHeight:1.15,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%"}}>{item.name}</div></div>)})}</div></div></div>
      {scrollDone&&wonItem&&(()=>{const rar=R[wonItem.rarity];const cs=caseStats(selCase?.id);const pp=cs.spent===0?"0.00":((cs.earned/cs.spent-1)*100).toFixed(2);const cond=getCondition(wonFloat);return(
        <div className="fadeUp" style={{display:"flex",flexDirection:"column",gap:"clamp(10px,2.5vw,16px)"}}>
          <div style={{background:"#141820",border:"1px solid #1e2430",borderRadius:"clamp(6px,1.5vw,10px)",padding:"clamp(16px,4vw,28px)",display:"flex",flexDirection:"column",alignItems:"center",gap:"clamp(6px,1.5vw,10px)"}}>
            <div style={{display:"flex",alignItems:"center",gap:"clamp(8px,2vw,14px)"}}><span style={{fontSize:"clamp(20px,5vw,32px)"}}>{selCase?.icon}</span><div><div style={{color:rar.color,fontSize:"clamp(14px,3.8vw,22px)",fontWeight:700}}>{wonItem.name}</div><div style={{color:"#999",fontSize:"clamp(10px,2.5vw,13px)"}}>{cond}</div></div></div>
            <div style={{width:"clamp(180px,55vw,340px)",height:3,background:rar.color,borderRadius:2,opacity:.6}}/>
            <Starburst color={rar.color}><span style={{fontSize:"clamp(40px,12vw,72px)"}}>{wonItem.icon}</span></Starburst>
            <div style={{color:"#ccc",fontSize:"clamp(11px,2.8vw,15px)",fontWeight:600,textAlign:"center",fontStyle:"italic"}}>{wonQuote}</div>
            <div style={{width:"clamp(200px,60vw,380px)"}}><div style={{display:"flex",justifyContent:"space-between",fontSize:"clamp(8px,2vw,10px)",color:"#888",marginBottom:3}}><span>MIN: 0.00</span><span>MAX: 1.00</span></div><div style={{position:"relative",height:6,borderRadius:4,overflow:"hidden",background:"linear-gradient(to right,#4ade80,#4ade80 7%,#a3e635 7%,#a3e635 15%,#fbbf24 15%,#fbbf24 38%,#f97316 38%,#f97316 45%,#ef4444 45%)"}}><div style={{position:"absolute",top:-2,bottom:-2,left:`${wonFloat*100}%`,width:2,background:"#fff",borderRadius:1,boxShadow:"0 0 4px #fff"}}/></div></div>
            <div style={{textAlign:"center"}}><span style={{color:"#999",fontSize:"clamp(10px,2.5vw,13px)"}}>Price: </span><span style={{color:wonItem.value>=selCase?.price?"#4ade80":"#eb4b4b",fontSize:"clamp(13px,3.5vw,18px)",fontWeight:800}}>{money(wonItem.value)}</span><span style={{color:"#666",fontSize:"clamp(9px,2.2vw,11px)"}}> | Float: {wonFloat.toFixed(4)}</span></div>
            {rentPaid>0&&<div style={{color:"#f59e0b",fontSize:"clamp(9px,2.2vw,11px)"}}>Rent: {money(rentPaid)}</div>}
            <div style={{display:"flex",width:"100%",gap:6,alignItems:"center",marginTop:6,flexWrap:"wrap"}}><div style={{background:selCase?.color+"22",border:`1px solid ${selCase?.color}44`,borderRadius:6,padding:"5px 10px",fontSize:"clamp(9px,2.2vw,11px)",color:selCase?.color,fontWeight:600}}>{selCase?.icon} {selCase?.name}: {money(selCase?.price)}</div><div style={{flex:1}}/><button onClick={()=>{setPage("shop");setOpening(false)}} style={{...S.btn,background:"#ffffff08",color:"#999"}}>Back</button>{lastWonId&&<button onClick={sellLastWon} style={{...S.btn,background:"#fbbf24",color:"#000",fontWeight:700}}>Sell {money(wonItem?.value||0)}</button>}<button onClick={openAgain} style={{...S.btn,background:"#4ade80",color:"#0a0c10",fontWeight:800}}>One more time</button></div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"clamp(8px,2vw,12px)"}}>
            <div style={{background:"#141820",border:"1px solid #1e2430",borderRadius:8,padding:"clamp(10px,2.5vw,16px)"}}><div style={{fontWeight:700,fontSize:"clamp(10px,2.5vw,13px)",marginBottom:8,color:"#ccc",textAlign:"center"}}>Container stats</div><div style={{display:"grid",gridTemplateColumns:"auto 1fr auto 1fr",gap:"2px 8px",fontSize:"clamp(9px,2.2vw,11px)"}}><span style={{color:"#888"}}>Opened:</span><span style={{fontWeight:600}}>{cs.opened}</span><span style={{color:"#888"}}>Spent:</span><span style={{fontWeight:600}}>{money(cs.spent)}</span><span style={{color:"#888"}}>Profit:</span><span style={{fontWeight:600,color:parseFloat(pp)>=0?"#4ade80":"#eb4b4b"}}>{pp}%</span><span style={{color:"#888"}}>Earned:</span><span style={{fontWeight:600}}>{money(cs.earned)}</span></div><div style={{marginTop:8,fontSize:"clamp(8px,2vw,10px)"}}>{RKEYS.filter(k=>k!=="consumer").map(k=><div key={k} style={{display:"flex",alignItems:"center",gap:4,marginBottom:1}}><span style={{color:R[k].color,fontWeight:600,width:"clamp(50px,16vw,75px)"}}>{R[k].label}</span><div style={{flex:1,height:10,background:`${R[k].color}22`,borderRadius:2}}/><span style={{color:"#ccc",width:24,textAlign:"right"}}>{cs.counts[k]||0}</span></div>)}</div></div>
            <div style={{background:"#141820",border:"1px solid #1e2430",borderRadius:8,padding:"clamp(10px,2.5vw,16px)",overflow:"hidden"}}><div style={{fontWeight:700,fontSize:"clamp(10px,2.5vw,13px)",marginBottom:8,color:"#ccc",textAlign:"center"}}>Latest drops</div><div style={{display:"flex",flexDirection:"column",gap:2,maxHeight:"clamp(120px,30vw,200px)",overflowY:"auto"}}>{drops.length===0?<div style={{color:"#555",fontSize:"clamp(9px,2.2vw,11px)"}}>None</div>:drops.slice(0,12).map((d,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"3px 6px",background:i===0?R[d.rarity].bg:"transparent",borderLeft:`2px solid ${R[d.rarity].color}`,borderRadius:3,fontSize:"clamp(8px,2vw,10px)"}}><span style={{color:"#ccc",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}><span style={{color:"#666"}}>{i+1}.</span> {d.icon} {d.name}</span><span style={{color:R[d.rarity].color,fontWeight:600,marginLeft:6,flexShrink:0}}>{money(d.value)}</span></div>)}</div></div>
          </div>
        </div>
      )})()}
    </div>}

    {/* INSPECT */}
    {page==="inspect"&&inspecting&&<div style={S.body}><button onClick={()=>setPage("shop")} style={{...S.btn,background:"#ffffff08",color:"#666",marginBottom:10}}>&larr; Back</button><div style={{fontSize:"clamp(15px,4vw,20px)",fontWeight:700,marginBottom:10}}>{inspecting.icon} {inspecting.name} &mdash; {money(inspecting.price)}</div><div style={S.iList}><div style={S.iHdr}><span>Item</span><span>Rarity</span><span>Value</span><span>Rate</span></div>{[...inspecting.items].sort((a,b)=>R[b.rarity].chance-R[a.rarity].chance).map((item,i)=>{const pool=inspecting.items.filter(x=>x.rarity===item.rarity).length;const p=((R[item.rarity].chance/pool)*100).toFixed(2);return(<div key={i} style={{...S.iRow,borderLeftColor:R[item.rarity].color}}><span style={{fontWeight:600}}>{item.icon} {item.name}</span><span style={{color:R[item.rarity].color,fontWeight:600}}>{R[item.rarity].label}</span><span style={{color:"#4ade80"}}>{money(item.value)}</span><span style={{color:"#666"}}>{p}%</span></div>)})}</div><div style={{marginTop:16}}><div style={{fontSize:"clamp(12px,3vw,14px)",fontWeight:600,marginBottom:8,color:"#777"}}>Drop Rates</div>{Object.entries(R).map(([k,v])=><div key={k} style={{display:"flex",alignItems:"center",gap:6,marginBottom:3}}><span style={{color:v.color,fontWeight:600,width:"clamp(60px,18vw,90px)",fontSize:"clamp(9px,2.5vw,12px)"}}>{v.label}</span><div style={{flex:1,height:5,background:"#1a1d24",borderRadius:3,overflow:"hidden"}}><div style={{height:"100%",borderRadius:3,background:v.color,width:`${Math.max(v.chance*200,1)}%`}}/></div><span style={{color:"#666",width:"clamp(32px,10vw,48px)",textAlign:"right",fontSize:"clamp(8px,2.2vw,11px)"}}>{(v.chance*100).toFixed(1)}%</span></div>)}</div></div>}

    {/* INVENTORY */}
    {page==="inv"&&<div style={S.body}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,flexWrap:"wrap",gap:6}}><div style={{fontSize:"clamp(15px,4vw,20px)",fontWeight:700}}>Inventory ({st.inv.length})</div><div style={{color:"#888",fontSize:"clamp(9px,2.2vw,11px)"}}>Total: {money(invTotal)} | {"\u2605"} {Object.keys(st.starred||{}).length}</div></div>
      <div style={{display:"flex",gap:4,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
        <select value={invSort} onChange={e=>setInvSort(e.target.value)} style={S.sel}><option value="newest">Newest</option><option value="oldest">Oldest</option><option value="value-high">Value ↓</option><option value="value-low">Value ↑</option><option value="rarity">Rarity</option><option value="name">Name</option></select>
        <select value={invFilter} onChange={e=>setInvFilter(e.target.value)} style={S.sel}><option value="all">All</option><option value="starred">{"\u2605"} Starred</option>{RKEYS.map(k=><option key={k} value={k}>{R[k].label}</option>)}</select>
        <button onClick={()=>setInvView(v=>v==="grid"?"list":"grid")} style={{...S.btn,background:"#ffffff08",color:"#888",padding:"5px 8px"}}>{invView==="grid"?"List":"Grid"}</button>
        <div style={{flex:1}}/>
        <input type="number" placeholder="#" value={sellAmt} onChange={e=>setSellAmt(e.target.value)} style={{...S.sel,width:"clamp(40px,12vw,60px)"}}/>
        <button onClick={()=>{const n=parseInt(sellAmt);if(n>0)setSellConfirm("count")}} disabled={!sellAmt||parseInt(sellAmt)<=0} style={{...S.btn,background:"#4ade8022",color:"#4ade80",padding:"5px 8px"}}>Sell #</button>
        <button onClick={()=>setSellConfirm("all")} disabled={unstarredCount===0} style={{...S.btn,background:"#eb4b4b22",color:"#eb4b4b",padding:"5px 8px"}}>Sell all</button>
      </div>
      {filteredInv.length===0?<div style={{color:"#555",padding:20,textAlign:"center"}}>No items match.</div>:
        invView==="grid"?<div style={S.invG}>{filteredInv.map((item,i)=>{const starred=st.starred?.[item.id];return(<div key={item.id||i} onClick={()=>setSelItem(item)} style={{...S.invI,borderLeftColor:R[item.rarity]?.color||"#555",cursor:"pointer",position:"relative",background:starred?"#ffd70008":"#0d1117"}}>{starred&&<div style={{position:"absolute",top:4,right:6,color:"#ffd700",fontSize:"clamp(10px,2.5vw,14px)"}}>{"\u2605"}</div>}<div style={{fontWeight:600,fontSize:"clamp(10px,2.8vw,13px)"}}>{item.icon} {item.name}</div><div style={{display:"flex",justifyContent:"space-between"}}><span style={{color:R[item.rarity]?.color,fontSize:"clamp(8px,2.2vw,10px)"}}>{R[item.rarity]?.label}</span><span style={{color:"#4ade80",fontSize:"clamp(9px,2.5vw,12px)",fontWeight:600}}>{money(item.value)}</span></div>{item.float!==undefined&&<div style={{color:"#666",fontSize:"clamp(7px,1.8vw,9px)"}}>{getCondition(item.float)}</div>}</div>)})}</div>:
        <div style={{display:"flex",flexDirection:"column",gap:2}}>{filteredInv.map((item,i)=>{const starred=st.starred?.[item.id];return(<div key={item.id||i} onClick={()=>setSelItem(item)} style={{display:"grid",gridTemplateColumns:"24px 1fr 80px 70px 24px",alignItems:"center",gap:6,padding:"5px 8px",background:starred?"#ffd70008":"#0d1117",borderLeft:`2px solid ${R[item.rarity]?.color}`,borderRadius:3,cursor:"pointer",fontSize:"clamp(8px,2.2vw,11px)"}}><span>{item.icon}</span><span style={{fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{item.name}</span><span style={{color:R[item.rarity]?.color,fontWeight:600}}>{R[item.rarity]?.label}</span><span style={{color:"#4ade80",fontWeight:600}}>{money(item.value)}</span><span style={{color:starred?"#ffd700":"#333"}}>{starred?"\u2605":"\u2606"}</span></div>)})}</div>}
    </div>}

    {/* STATS */}
    {page==="stats"&&(()=>{const hist=st.history||[{n:0,bal:DEFAULT_BAL}];const vals=hist.map(h=>h.bal);const minV=Math.min(...vals,0);const maxV=Math.max(...vals,DEFAULT_BAL);const range=maxV-minV||1;const W=800,H=320,PAD={t:30,r:20,b:40,l:60};const cw=W-PAD.l-PAD.r,ch=H-PAD.t-PAD.b;const x=i=>PAD.l+(hist.length<=1?cw/2:(i/(hist.length-1))*cw);const y=v=>PAD.t+ch-((v-minV)/range)*ch;const pts=hist.map((h,i)=>`${x(i)},${y(h.bal)}`).join(" ");const area=`M${x(0)},${y(hist[0].bal)} `+hist.map((h,i)=>`L${x(i)},${y(h.bal)}`).join(" ")+` L${x(hist.length-1)},${y(minV)} L${x(0)},${y(minV)} Z`;const tips=hist.map((h,i)=>h.label?{...h,i}:null).filter(Boolean);const gridLines=[];for(let g=0;g<=5;g++){const val=minV+(range*g)/5;gridLines.push({y:y(val),val})}const startY=y(DEFAULT_BAL);return(
      <div style={S.body}><div style={{fontSize:"clamp(15px,4vw,20px)",fontWeight:700,marginBottom:10}}>Stats</div>
        <div style={{background:"#0d1117",border:"1px solid #151820",borderRadius:10,padding:"clamp(10px,2.5vw,16px)",marginBottom:14,overflow:"hidden"}}><div style={{fontSize:"clamp(10px,2.5vw,13px)",fontWeight:700,color:"#888",marginBottom:8}}>Balance History</div>
          {hist.length<2?<div style={{color:"#555",fontSize:12,padding:"20px 0",textAlign:"center"}}>Open cases to see data</div>:
          <svg viewBox={`0 0 ${W} ${H}`} style={{width:"100%",height:"auto"}}>
            {gridLines.map((g,i)=><g key={i}><line x1={PAD.l} y1={g.y} x2={W-PAD.r} y2={g.y} stroke="#1a1d24" strokeWidth="1"/><text x={PAD.l-6} y={g.y+4} fill="#444" fontSize="10" textAnchor="end" fontFamily="JetBrains Mono">{Math.abs(g.val)>=1000?(g.val/1000).toFixed(0)+"k":Math.round(g.val)}</text></g>)}
            {[0,Math.floor(hist.length/4),Math.floor(hist.length/2),Math.floor(hist.length*3/4),hist.length-1].filter((v,i,a)=>a.indexOf(v)===i).map(i=><text key={i} x={x(i)} y={H-8} fill="#444" fontSize="10" textAnchor="middle" fontFamily="JetBrains Mono">#{hist[i].n}</text>)}
            {minV<0&&<line x1={PAD.l} y1={y(0)} x2={W-PAD.r} y2={y(0)} stroke="#eb4b4b44" strokeWidth="1" strokeDasharray="4,4"/>}
            <line x1={PAD.l} y1={startY} x2={W-PAD.r} y2={startY} stroke="#4ade8033" strokeWidth="1" strokeDasharray="4,4"/>
            <defs><linearGradient id="aG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#4ade80" stopOpacity=".15"/><stop offset="60%" stopColor="#4ade80" stopOpacity=".03"/><stop offset="100%" stopColor="#eb4b4b" stopOpacity=".08"/></linearGradient><linearGradient id="lG" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#4ade80"/><stop offset="100%" stopColor={profit>=0?"#4ade80":"#eb4b4b"}/></linearGradient></defs>
            <path d={area} fill="url(#aG)"/><polyline points={pts} fill="none" stroke="url(#lG)" strokeWidth="2" strokeLinejoin="round" strokeLinecap="round"/>
            <circle cx={x(hist.length-1)} cy={y(hist[hist.length-1].bal)} r="4" fill={profit>=0?"#4ade80":"#eb4b4b"}/>
            {tips.map((t,ti)=>{const tx=x(t.i),ty=y(t.bal),above=ty>H/2;return(<g key={ti}><line x1={tx} y1={ty} x2={tx} y2={above?ty-30:ty+30} stroke="#ffd70088" strokeWidth="1" strokeDasharray="2,2"/><circle cx={tx} cy={ty} r="3.5" fill="#ffd700"/><rect x={tx-50} y={above?ty-46:ty+32} width="100" height="14" rx="3" fill="#141820" stroke="#ffd70044" strokeWidth=".5"/><text x={tx} y={above?ty-36:ty+42} fill="#ffd700" fontSize="7.5" textAnchor="middle" fontFamily="JetBrains Mono" fontWeight="600">{t.label.length>18?t.label.slice(0,18)+"..":t.label}</text></g>)})}
            <line x1={PAD.l} y1={PAD.t} x2={PAD.l} y2={H-PAD.b} stroke="#1e2430" strokeWidth="1"/><line x1={PAD.l} y1={H-PAD.b} x2={W-PAD.r} y2={H-PAD.b} stroke="#1e2430" strokeWidth="1"/>
          </svg>}
          <div style={{display:"flex",gap:14,marginTop:6,flexWrap:"wrap",fontSize:"clamp(8px,2vw,10px)"}}><span style={{display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:"50%",background:"#4ade80",display:"inline-block"}}/> Profit</span><span style={{display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:"50%",background:"#eb4b4b",display:"inline-block"}}/> Loss</span><span style={{display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:"50%",background:"#ffd700",display:"inline-block"}}/> Big win</span></div>
        </div>
        <div style={S.stG}>{[["Opened",st.stats.opened],["Spent",money(st.stats.spent)],["Won",money(st.stats.won)],["Profit",money(profit)],["Sold",money(st.stats.sold||0)],["Best",st.stats.best||"\u2014"],["Debt",money(st.loan)],["Inv Value",money(invTotal)]].map(([l,v],i)=><div key={i} style={S.stI}><div style={{color:"#555",fontSize:"clamp(8px,2.2vw,10px)",textTransform:"uppercase",letterSpacing:1}}>{l}</div><div style={{fontSize:"clamp(14px,4vw,20px)",fontWeight:700,color:l==="Profit"?(profit>=0?"#4ade80":"#eb4b4b"):l==="Sold"?"#fbbf24":"#e2e8f0"}}>{v}</div></div>)}</div>
      </div>)})()}

    {/* LOAN */}
    {page==="loan"&&<div style={S.body}><div style={{fontSize:"clamp(15px,4vw,20px)",fontWeight:700,marginBottom:10}}>Loan</div><div style={S.loanBox}><div style={{display:"flex",gap:18,flexWrap:"wrap",marginBottom:16}}>{[["DEBT",st.loan,st.loan>0?"#eb4b4b":"#4ade80"],["LIMIT",MAX_LOAN,"#f59e0b"],["AVAIL",Math.max(0,MAX_LOAN-st.loan),"#e2e8f0"]].map(([l,v,c])=><div key={l}><div style={{color:"#555",fontSize:"clamp(8px,2vw,10px)"}}>{l}</div><div style={{fontSize:"clamp(16px,4.5vw,24px)",fontWeight:700,color:c}}>{money(v)}</div></div>)}</div><div style={{color:"#f59e0b",fontSize:11,marginBottom:6}}>{LOAN_RATE*100}% interest.</div><div style={{color:"#eb4b4b",fontSize:10,marginBottom:12}}>Broke + maxed = auto reset.</div><div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"}}><input type="number" placeholder="Amount" value={loanAmt} onChange={e=>setLoanAmt(e.target.value)} style={S.input}/><button onClick={borrow} disabled={MAX_LOAN-st.loan<=0} style={{...S.btn,background:"#f59e0b",color:"#000"}}>Borrow</button><button onClick={repay} disabled={st.loan<=0||st.bal<=0} style={{...S.btn,background:"#4ade80",color:"#000"}}>Repay</button></div></div></div>}

  </div>);
}

const CSS=`@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&display=swap');*{box-sizing:border-box;margin:0;padding:0}::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-thumb{background:#222;border-radius:2px}::-webkit-scrollbar-track{background:transparent}@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}.fadeUp{animation:fadeUp .4s ease-out}button{cursor:pointer;font-family:inherit}button:disabled{opacity:.3;cursor:not-allowed}input:focus,select:focus{outline:1px solid #333}select{-webkit-appearance:none;appearance:none}`;

const S={
  root:{fontFamily:"'JetBrains Mono',monospace",background:"#0a0c10",color:"#e2e8f0",minHeight:"100vh",display:"flex",flexDirection:"column",fontSize:"clamp(11px,2.8vw,14px)"},
  hdr:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"clamp(8px,2vw,14px) clamp(12px,3vw,20px)",borderBottom:"1px solid #151820",flexWrap:"wrap",gap:6},
  title:{fontSize:"clamp(16px,4.5vw,22px)",fontWeight:800,letterSpacing:3,color:"#ccc"},
  hdrRight:{display:"flex",alignItems:"center",gap:"clamp(4px,1.5vw,8px)",flexWrap:"wrap"},
  chip:{display:"flex",flexDirection:"column",alignItems:"center",background:"#0d1117",border:"1px solid #151820",borderRadius:8,padding:"2px clamp(8px,2.5vw,14px)"},
  chipLbl:{color:"#444",fontSize:"clamp(7px,1.8vw,9px)",letterSpacing:1},
  rentChip:{background:"#f59e0b0a",border:"1px solid #f59e0b1a",borderRadius:8,padding:"4px 10px",fontSize:"clamp(9px,2.2vw,11px)",color:"#f59e0b",fontWeight:600},
  nav:{display:"flex",gap:3,padding:"6px clamp(12px,3vw,20px)",borderBottom:"1px solid #151820",flexWrap:"wrap"},
  tab:{background:"transparent",border:"none",color:"#444",padding:"6px 12px",fontSize:"clamp(10px,2.5vw,13px)",fontWeight:600,borderRadius:6,transition:"all .15s"},
  tabOn:{background:"#ffffff06",color:"#ccc"},
  body:{padding:"clamp(12px,3vw,20px)",flex:1,maxWidth:960,margin:"0 auto",width:"100%",overflowX:"hidden"},
  grid:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(clamp(130px,28vw,180px),1fr))",gap:"clamp(8px,2vw,12px)"},
  card:{background:"#0d1117",border:"1px solid",borderRadius:12,padding:"clamp(10px,2.5vw,16px)",display:"flex",flexDirection:"column",alignItems:"center",gap:6},
  cardIcon:{width:"clamp(44px,12vw,64px)",height:"clamp(44px,12vw,64px)",borderRadius:12,border:"1px solid",display:"flex",alignItems:"center",justifyContent:"center"},
  cardName:{fontWeight:700,fontSize:"clamp(10px,2.6vw,13px)",textAlign:"center"},
  cardPrice:{fontWeight:800,fontSize:"clamp(13px,3.5vw,18px)"},
  btn:{border:"none",padding:"clamp(7px,1.8vw,10px) clamp(10px,3vw,16px)",borderRadius:6,fontWeight:700,fontSize:"clamp(10px,2.5vw,13px)",transition:"all .15s"},
  scrollOuter:{position:"relative",marginBottom:14},
  marker:{position:"absolute",top:0,bottom:0,left:"50%",width:2,background:"#ffd700",zIndex:10,transform:"translateX(-50%)",boxShadow:"0 0 10px #ffd70044"},
  scrollClip:{overflow:"hidden",borderRadius:8,border:"1px solid #151820",background:"#080a0e"},
  strip:{display:"flex",willChange:"transform"},
  sItem:{width:"16%",minWidth:"16%",aspectRatio:"1/1.15",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3,borderBottom:"3px solid",padding:2,flexShrink:0,transition:"background .3s,transform .3s"},
  iList:{display:"flex",flexDirection:"column",gap:1},
  iHdr:{display:"grid",gridTemplateColumns:"1fr 80px 65px 50px",padding:"4px 8px",fontSize:"clamp(7px,1.8vw,10px)",color:"#444",textTransform:"uppercase",letterSpacing:1},
  iRow:{display:"grid",gridTemplateColumns:"1fr 80px 65px 50px",padding:"6px 8px",background:"#0d1117",borderLeft:"2px solid",borderRadius:3,fontSize:"clamp(8px,2.2vw,11px)",alignItems:"center"},
  invG:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(clamp(140px,38vw,200px),1fr))",gap:6},
  invI:{background:"#0d1117",borderRadius:6,padding:"8px 10px",borderLeft:"2px solid",display:"flex",flexDirection:"column",gap:2,border:"1px solid transparent"},
  stG:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(clamp(120px,35vw,170px),1fr))",gap:8},
  stI:{background:"#0d1117",border:"1px solid #151820",borderRadius:8,padding:"clamp(8px,2.5vw,14px)",display:"flex",flexDirection:"column",gap:3},
  loanBox:{background:"#0d1117",border:"1px solid #151820",borderRadius:12,padding:"clamp(14px,4vw,24px)"},
  input:{background:"#080a0e",border:"1px solid #151820",borderRadius:6,padding:"8px 12px",color:"#e2e8f0",fontSize:"clamp(11px,2.8vw,14px)",fontFamily:"inherit",width:"clamp(100px,30vw,140px)"},
  sel:{background:"#080a0e",border:"1px solid #151820",borderRadius:6,padding:"5px 8px",color:"#e2e8f0",fontSize:"clamp(9px,2.2vw,11px)",fontFamily:"inherit"},
  overlay:{position:"fixed",inset:0,background:"rgba(0,0,0,.88)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:999},
  modal:{background:"#141820",border:"1px solid #1e2430",borderRadius:14,padding:"clamp(20px,5vw,32px)",display:"flex",flexDirection:"column",alignItems:"center",gap:10,maxWidth:"clamp(280px,80vw,400px)",width:"100%"},
  slotBtn:{background:"#0d1117",border:"1px solid #1e2430",borderRadius:12,padding:"clamp(14px,3.5vw,20px)",display:"flex",flexDirection:"column",gap:6,cursor:"pointer",fontFamily:"inherit",color:"#e2e8f0",width:"100%",transition:"all .15s",fontSize:"clamp(11px,2.8vw,14px)"},
};

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>
