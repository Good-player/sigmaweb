<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SigmaWeb AI Chat (Claude)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; }
        .chat-container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 24px; }
        .chat-history { height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 16px; background: #fafbfc; }
        .msg { margin-bottom: 14px; display: flex; }
        .msg.user { justify-content: flex-end; }
        .msg.ai { justify-content: flex-start; }
        .msg .bubble { display: inline-block; padding: 10px 16px; border-radius: 18px; max-width: 80%; background: #e9ecef; color: #222; white-space: pre-wrap; word-break: break-word; }
        .msg.user .bubble { background: #007bff; color: #fff; }
        .code-card {
            background: #222;
            color: #eee;
            border-radius: 12px;
            margin: 8px 0;
            font-size: 15px;
            overflow-x: auto;
            border: 1px solid #333;
            box-shadow: 0 2px 8px #bbb;
            padding: 0;
            position: relative;
            max-width: 340px;
            min-width: 240px;
            margin-left: 12px;
        }
        .code-card-main { padding: 18px 14px 12px 16px; font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace; white-space: pre; }
        .code-card-buttons {
            position: absolute;
            top: 8px;
            right: 12px;
            display: flex;
            gap: 6px;
        }
        .code-label {
            display: block;
            font-size: 13px;
            color: #007bff;
            background: #e9ecef;
            border-radius: 5px;
            padding: 2px 8px;
            margin-bottom: 3px;
            margin-left: 16px;
            margin-top: 10px;
            width: fit-content;
        }
        .code-btn {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            padding: 2px 8px;
            cursor: pointer;
        }
        .code-btn:active { background: #005bb5; }
        .input-row { display: flex; gap: 8px; }
        input[type="text"], input[type="number"] { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; background: #007bff; color: #fff; font-size: 16px; cursor: pointer; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .logo { text-align: center; margin-bottom: 18px; }
        .logo span { font-weight: bold; font-size: 1.3em; color: #007bff; }
        .history-btn-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .mode-switch { margin-left: auto; }
        .mode-btn { background: #e9ecef; color: #007bff; border: none; border-radius: 5px; font-size: 14px; padding: 6px 13px; cursor: pointer; margin-left: 5px; }
        .mode-btn.active { background: #007bff; color: #fff; }
        .tab-row { display: flex; gap: 2px; margin-bottom: 5px; }
        .tab-btn { background: #e9ecef; color: #007bff; border: none; border-radius: 5px 5px 0 0; font-size: 14px; padding: 6px 13px; cursor: pointer;}
        .tab-btn.active { background: #fff; color: #007bff; border-bottom: 2px solid #007bff; }
        .tab-content { background: #fff; border-radius: 0 0 6px 6px; border: 1px solid #eee; border-top: none; padding: 10px; }
        .anthropic-settings { margin-bottom: 12px; padding: 10px; background: #f0f4ff; border-radius: 7px; }
        .anthropic-settings label { font-size: 14px; margin-right: 8px; }
        .anthropic-settings input, .anthropic-settings select { font-size: 15px; margin-right: 8px; border-radius: 5px; border: 1px solid #ccc; padding: 4px 8px; }
        @media (max-width: 700px) {
            .chat-container { max-width: 98vw; }
            .code-card { max-width: 99vw; min-width: 0; margin-left: 0; }
        }
        h1, h2, h3, h4, h5, h6 { margin: 0.7em 0 0.3em 0; }
        ul { margin: 0.3em 0 0.3em 1em; }
        li { margin-bottom: 0.2em; }
        a { color: #007bff; text-decoration: underline; }
        b { font-weight: bold; }
        i { font-style: italic; }
        code { background: #eee; color: #d6336c; border-radius: 4px; padding: 2px 6px; font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace; font-size: 0.99em; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="logo"><span>SigmaWeb AI Chat (Claude)</span></div>
        <form id="anthropicSettingsForm" class="anthropic-settings" autocomplete="off">
            <label for="systemPrompt">System prompt:</label>
            <input type="text" id="systemPrompt" placeholder="Optional system prompt" />
            <label for="modelSelect">Model:</label>
            <select id="modelSelect">
                <option value="claude-3-opus-20240229" selected>claude-3-opus-20240229</option>
                <option value="claude-3-sonnet-20240229">claude-3-sonnet-20240229</option>
                <option value="claude-3-haiku-20240307">claude-3-haiku-20240307</option>
                <option value="claude-2.1">claude-2.1</option>
                <option value="claude-2.0">claude-2.0</option>
            </select>
            <label for="maxTokens">max_tokens:</label>
            <input type="number" id="maxTokens" min="1" max="4096" value="512" style="width:70px"/>
            <label for="temperature">temperature:</label>
            <input type="number" id="temperature" min="0" max="1" step="0.01" value="0.5" style="width:60px"/>
            <label for="topP">top_p:</label>
            <input type="number" id="topP" min="0" max="1" step="0.01" value="1.0" style="width:60px"/>
            <label for="topK">top_k:</label>
            <input type="number" id="topK" min="1" max="100" step="1" value="1" style="width:60px"/>
            <label for="stopSequences">stop_sequences:</label>
            <input type="text" id="stopSequences" placeholder="Comma separated" style="width:120px"/>
            <label for="metadata">metadata:</label>
            <input type="text" id="metadata" placeholder="key:value, ..." style="width:120px"/>
        </form>
        <div class="history-btn-row">
            <button id="deleteHistoryBtn" title="Delete chat history" style="background:#f44336; color:white;">Delete history</button>
            <div class="mode-switch">
                <button class="mode-btn active" id="chatModeBtn">Chat</button>
                <button class="mode-btn" id="searchModeBtn">Search</button>
            </div>
        </div>
        <div id="chatHistory" class="chat-history"></div>
        <form id="chatForm" class="input-row" autocomplete="off">
            <input type="text" id="userInput" placeholder="Type your message..." required autofocus />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
        const chatModeBtn = document.getElementById('chatModeBtn');
        const searchModeBtn = document.getElementById('searchModeBtn');
        // Anthropic settings
        const anthropicSettingsForm = document.getElementById('anthropicSettingsForm');
        const systemPromptInput = document.getElementById('systemPrompt');
        const modelSelect = document.getElementById('modelSelect');
        const maxTokensInput = document.getElementById('maxTokens');
        const temperatureInput = document.getElementById('temperature');
        const topPInput = document.getElementById('topP');
        const topKInput = document.getElementById('topK');
        const stopSequencesInput = document.getElementById('stopSequences');
        const metadataInput = document.getElementById('metadata');

        let mode = 'chat'; // 'chat' or 'search'
        let searchTabs = ['Answer', 'References'];
        let searchTabActive = 'Answer';
        let lastSearchReferences = [];

        chatModeBtn.onclick = () => {
            mode = 'chat';
            chatModeBtn.classList.add('active');
            searchModeBtn.classList.remove('active');
            userInput.placeholder = "Type your message...";
            searchTabActive = 'Answer';
            renderHistory();
        };
        searchModeBtn.onclick = () => {
            mode = 'search';
            chatModeBtn.classList.remove('active');
            searchModeBtn.classList.add('active');
            userInput.placeholder = "Type your search query...";
            searchTabActive = 'Answer';
            renderHistory();
        };

        let history = JSON.parse(localStorage.getItem('sigmaweb_claude_chat') || '[]');
        renderHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage('user', text);
            userInput.value = '';
            chatForm.querySelector('button').disabled = true;
            await aiReplyStream(text, history);
            chatForm.querySelector('button').disabled = false;
        });

        deleteHistoryBtn.onclick = function() {
            if (confirm("Delete all chat history?")) {
                localStorage.removeItem('sigmaweb_claude_chat');
                history = [];
                lastSearchReferences = [];
                renderHistory();
            }
        };

        function addMessage(role, content, meta={}) {
            history.push({ role, content, meta });
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }

        function renderMarkdown(text) {
            text = escapeHtml(text);
            text = text.replace(/^###### (.*)$/gm, '<h6>$1</h6>')
                       .replace(/^##### (.*)$/gm, '<h5>$1</h5>')
                       .replace(/^#### (.*)$/gm, '<h4>$1</h4>')
                       .replace(/^### (.*)$/gm, '<h3>$1</h3>')
                       .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                       .replace(/^# (.*)$/gm, '<h1>$1</h1>');
            text = text.replace(/^[ \t]*[-*] (.*)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                       .replace(/\*(.*?)\*/g, '<i>$1</i>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/\[([^\]]+)\]\(([^ )]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            return text;
        }

        function renderMsgContent(content) {
            const codeBlockRegex = /```([a-zA-Z0-9]*)\s*([\s\S]*?)```/g;
            let lastIndex = 0;
            let htmlParts = [];
            let match;
            let isDesktop = window.innerWidth > 700;
            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    htmlParts.push(renderMarkdown(content.substring(lastIndex, match.index)));
                }
                const lang = match[1] || 'code';
                const code = match[2];
                htmlParts.push(
                    isDesktop
                    ? `<div class="code-card">
                        <span class="code-label">${escapeHtml(lang.toUpperCase())} CODE</span>
                        <div class="code-card-main">${escapeHtml(code)}</div>
                        <div class="code-card-buttons">
                            <button class="code-btn copy-btn" data-code="${encodeURIComponent(code)}">Copy</button>
                            <button class="code-btn run-btn" data-code="${encodeURIComponent(code)}" data-lang="${lang}">Run</button>
                        </div>
                    </div>`
                    : `<div class="code-label">${escapeHtml(lang.toUpperCase())} CODE</div><pre class="code-block">${escapeHtml(code)}</pre>`
                );
                lastIndex = codeBlockRegex.lastIndex;
            }
            if (lastIndex < content.length) {
                htmlParts.push(renderMarkdown(content.substring(lastIndex)));
            }
            return htmlParts.join('');
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderHistory() {
            chatHistory.innerHTML = '';
            if (mode === 'search' && lastSearchReferences.length > 0) {
                let tabRow = document.createElement('div');
                tabRow.className = 'tab-row';
                searchTabs.forEach(tab => {
                    let btn = document.createElement('button');
                    btn.className = 'tab-btn' + (searchTabActive === tab ? ' active' : '');
                    btn.textContent = tab;
                    btn.onclick = () => {
                        searchTabActive = tab;
                        renderHistory();
                    };
                    tabRow.appendChild(btn);
                });
                chatHistory.appendChild(tabRow);

                let tabContent = document.createElement('div');
                tabContent.className = 'tab-content';
                if (searchTabActive === 'Answer') {
                    history.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'msg ' + msg.role;
                        const bubble = document.createElement('div');
                        bubble.className = 'bubble';
                        if (msg.role === 'ai') {
                            bubble.innerHTML = renderMsgContent(msg.content);
                        } else {
                            bubble.textContent = msg.content;
                        }
                        div.appendChild(bubble);
                        tabContent.appendChild(div);
                    });
                } else if (searchTabActive === 'References') {
                    if (lastSearchReferences.length > 0) {
                        tabContent.innerHTML = lastSearchReferences.map(ref => 
                            `<div><a href="${escapeHtml(ref.url)}" target="_blank">${escapeHtml(ref.title || ref.url)}</a>
                            ${ref.snippet ? `<br><small>${escapeHtml(ref.snippet)}</small>` : ''}</div>`
                        ).join('<hr>');
                    } else {
                        tabContent.innerHTML = "<em>No references found.</em>";
                    }
                }
                chatHistory.appendChild(tabContent);
            } else {
                history.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'msg ' + msg.role;
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    if (msg.role === 'ai') {
                        bubble.innerHTML = renderMsgContent(msg.content);
                    } else {
                        bubble.textContent = msg.content;
                    }
                    div.appendChild(bubble);
                    chatHistory.appendChild(div);
                });
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
            attachCodeBtns();
        }

        function attachCodeBtns() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.onclick = function() {
                    const code = decodeURIComponent(this.getAttribute('data-code'));
                    navigator.clipboard.writeText(code);
                    btn.textContent = "Copied!";
                    setTimeout(() => btn.textContent = "Copy", 1200);
                };
            });
            document.querySelectorAll('.run-btn').forEach(btn => {
                btn.onclick = function() {
                    const code = decodeURIComponent(this.getAttribute('data-code'));
                    const lang = (this.getAttribute('data-lang') || '').toLowerCase();
                    if (lang === 'html') {
                        const win = window.open();
                        win.document.write(code);
                    } else if (lang === 'js' || lang === 'javascript') {
                        try { eval(code); } catch(e) { alert("Error: " + e.message); }
                    } else {
                        alert("Run only supported for HTML and JS.");
                    }
                };
            });
        }

        // Build metadata object from string "key:value, key2:value2"
        function parseMetadata(str) {
            const meta = {};
            (str || "").split(',').forEach(pair => {
                const [key, value] = pair.split(':').map(s => s && s.trim());
                if (key && value) meta[key] = value;
            });
            return meta;
        }

        async function aiReplyStream(userMsg, historySnapshot) {
            addMessage('ai', '');
            let idx = history.length - 1;
            let fullText = '';
            lastSearchReferences = [];
            const messages = [];
            // Add system prompt if set (Anthropic: system message, see docs)
            const systemPrompt = systemPromptInput.value.trim();
            if (systemPrompt) {
                messages.push({ role: 'system', content: systemPrompt });
            }
            // Add previous chat history
            historySnapshot.forEach(msg => {
                if (
                    (msg.role === 'user' || msg.role === 'ai') &&
                    msg.content && msg.content.trim() !== ""
                ) {
                    messages.push({
                        role: msg.role === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                }
            });
            messages.push({ role: 'user', content: userMsg });

            try {
                const keyResp = await fetch('/sigmaweb/api/claudeapi.txt');
                const apiKey = (await keyResp.text()).trim();
                const endpoint = 'https://api.anthropic.com/v1/messages';
                const model = modelSelect.value;
                const max_tokens = parseInt(maxTokensInput.value) || 512;
                const temperature = parseFloat(temperatureInput.value) || undefined;
                const top_p = parseFloat(topPInput.value) || undefined;
                const top_k = parseInt(topKInput.value) || undefined;
                // Stop sequences as array
                const stop_sequences = stopSequencesInput.value.trim()
                    ? stopSequencesInput.value.split(',').map(s => s.trim()).filter(s => s)
                    : undefined;
                // Metadata as object
                const metadata = metadataInput.value.trim()
                    ? parseMetadata(metadataInput.value)
                    : undefined;

                // Build request body with all optional fields
                const body = {
                    model,
                    max_tokens,
                    messages
                };
                if (temperature !== undefined) body.temperature = temperature;
                if (top_p !== undefined) body.top_p = top_p;
                if (top_k !== undefined) body.top_k = top_k;
                if (stop_sequences && stop_sequences.length > 0) body.stop_sequences = stop_sequences;
                if (metadata && Object.keys(metadata).length > 0) body.metadata = metadata;

                const resp = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    let errorMsg = 'Claude API error.';
                    try {
                        const errorData = await resp.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg += ' ' + errorData.error.message;
                        }
                    } catch {}
                    updateAiMsg(idx, errorMsg);
                } else {
                    const data = await resp.json();
                    const aiText = data.content?.[0]?.text || 'No reply from Claude.';
                    for (let i = 0; i < aiText.length; i++) {
                        fullText = aiText.slice(0, i + 1);
                        updateAiMsg(idx, fullText);
                        await new Promise(res => setTimeout(res, 7));
                    }
                    updateAiMsg(idx, aiText);

                    // References tab
                    let refs = [];
                    // Anthropic API docs: citations, sources, references possible
                    if (data.content?.[0]?.citations) {
                        refs = data.content[0].citations;
                    } else if (data.content?.[0]?.sources) {
                        refs = data.content[0].sources;
                    } else if (data.content?.[0]?.references) {
                        refs = data.content[0].references;
                    }
                    // Fallback: look for URLs in the text
                    if ((!refs || refs.length === 0) && aiText.match(/https?:\/\/[^\s]+/g)) {
                        refs = aiText.match(/https?:\/\/[^\s]+/g).map(url => ({ url }));
                    }
                    lastSearchReferences = (Array.isArray(refs) ? refs : []);
                    if (mode === 'search') renderHistory();
                }
            } catch (err) {
                updateAiMsg(idx, 'Error contacting Claude API.');
            }
        }

        function updateAiMsg(idx, text) {
            history[idx].content = text;
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }
    </script>
</body>
</html>
