<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SigmaWeb AI Chat (Claude)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts and Fira Mono for code -->
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: linear-gradient(135deg, #e7f0ff 0%, #f5f6fa 100%);
            margin: 0;
            min-height: 100vh;
        }
        .chat-container {
            max-width: 700px;
            margin: 48px auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 8px 24px #c5d0e0;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .logo {
            text-align: center;
            padding: 36px 0 20px 0;
            background: linear-gradient(90deg, #007bff14 0%, #fff 70%);
        }
        .logo span {
            font-weight: bold;
            font-size: 2.2em;
            color: #007bff;
            letter-spacing: 2px;
        }
        .history-btn-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 32px 0 32px;
        }
        .mode-switch {
            margin-left: auto;
        }
        .mode-btn {
            background: #e9ecef;
            color: #007bff;
            border: none;
            border-radius: 7px;
            font-size: 16px;
            padding: 8px 22px;
            cursor: pointer;
            margin-left: 12px;
            transition: background 0.2s;
        }
        .mode-btn.active {
            background: #007bff;
            color: #fff;
        }
        #deleteHistoryBtn {
            background: #f44336;
            color: #fff;
            font-size: 16px;
            padding: 8px 20px;
            border-radius: 7px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        #deleteHistoryBtn:hover {
            background: #d32f2f;
        }
        .chat-history {
            flex: 1;
            min-height: 320px;
            max-height: 520px;
            overflow-y: auto;
            border: 1px solid #e4e7ec;
            border-radius: 10px;
            padding: 24px;
            margin: 0 32px 0 32px;
            background: #f5f7ff;
            box-shadow: 0 2px 16px #e3e8f0 inset;
            transition: background 0.2s;
        }
        .msg {
            margin-bottom: 24px;
            display: flex;
        }
        .msg.user {
            justify-content: flex-end;
        }
        .msg.ai {
            justify-content: flex-start;
        }
        .msg .bubble {
            display: inline-block;
            padding: 17px 22px;
            border-radius: 22px;
            max-width: 75vw;
            background: #e9ecef;
            color: #222;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 17px;
            box-shadow: 0 2px 8px #dbe3f3;
            border: 1px solid #e4e7ec;
        }
        .msg.user .bubble {
            background: linear-gradient(90deg, #007bff 0%, #339af0 100%);
            color: #fff;
            border: 1px solid #b3d0ff;
            box-shadow: 0 2px 8px #b3d0ff;
        }
        .msg.ai .bubble {
            background: #f6f8fd;
            color: #222;
            border: 1px solid #cfd8dc;
        }
        .code-card {
            background: #161d2a;
            color: #eee;
            border-radius: 14px;
            margin: 14px 0;
            font-size: 16px;
            overflow-x: auto;
            border: 1px solid #333;
            box-shadow: 0 2px 12px #b3c0d7;
            padding: 0;
            position: relative;
            max-width: 440px;
            min-width: 220px;
            margin-left: 18px;
            font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
        }
        .code-card-main {
            padding: 22px 14px 14px 20px;
            font-family: inherit;
            white-space: pre;
            font-size: 15.5px;
            background: none;
        }
        .code-card-buttons {
            position: absolute;
            top: 10px;
            right: 18px;
            display: flex;
            gap: 9px;
        }
        .code-label {
            display: block;
            font-size: 15px;
            color: #007bff;
            background: #e9ecef;
            border-radius: 8px;
            padding: 4px 12px;
            margin-bottom: 8px;
            margin-left: 18px;
            margin-top: 16px;
            width: fit-content;
            font-family: 'Fira Mono', monospace;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .code-btn {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            padding: 3px 14px;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        .code-btn:active {
            background: #005bb5;
        }
        .input-row {
            display: flex;
            gap: 14px;
            padding: 26px 32px 24px 32px;
            background: #f9fbff;
            border-radius: 0 0 14px 14px;
        }
        input[type="text"] {
            flex: 1;
            padding: 13px;
            border-radius: 8px;
            border: 1.5px solid #b5c6e0;
            font-size: 19px;
            background: #fefefe;
            transition: box-shadow 0.2s;
            box-shadow: 0 2px 8px #e2ebfa inset;
        }
        input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 2px 12px #cee3fc inset;
        }
        button {
            padding: 13px 25px;
            border-radius: 8px;
            border: none;
            background: #007bff;
            color: #fff;
            font-size: 19px;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        /* Markdown styles */
        h1, h2, h3, h4, h5, h6 { margin: 0.7em 0 0.3em 0; font-weight: 600;}
        ul { margin: 0.3em 0 0.3em 1em; }
        li { margin-bottom: 0.2em; }
        a { color: #007bff; text-decoration: underline; }
        b { font-weight: bold; }
        i { font-style: italic; }
        code {
            background: #eee;
            color: #d6336c;
            border-radius: 6px;
            padding: 2px 8px;
            font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
            font-size: 1em;
            margin: 0 1px;
        }
        .streaming {
            min-height: 19px;
            animation: blink 1.3s infinite;
            border-right: 2px solid #007bff;
        }
        @keyframes blink {
            0%, 100% { border-right: 2px solid #007bff; }
            50% { border-right: 2px solid transparent; }
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 9px; background: #f5f7ff;}
        ::-webkit-scrollbar-thumb { background: #b9c8d3; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #007bff33;}
        @media (max-width: 900px) {
            .chat-container { max-width: 98vw; padding: 0;}
            .code-card { max-width: 99vw; min-width: 0; margin-left: 0; }
            .logo span { font-size: 1.1em;}
            .chat-history { margin: 0 4vw 0 4vw;}
            .input-row { padding: 24px 4vw 22px 4vw;}
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="logo"><span>SigmaWeb AI Chat (Claude)</span></div>
        <div class="history-btn-row">
            <button id="deleteHistoryBtn" title="Delete chat history">Delete history</button>
            <div class="mode-switch">
                <button class="mode-btn active" id="chatModeBtn">Chat</button>
                <button class="mode-btn" id="searchModeBtn">Search</button>
            </div>
        </div>
        <div id="chatHistory" class="chat-history"></div>
        <form id="chatForm" class="input-row" autocomplete="off">
            <input type="text" id="userInput" placeholder="Type your message..." required autofocus />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
        const chatModeBtn = document.getElementById('chatModeBtn');
        const searchModeBtn = document.getElementById('searchModeBtn');

        let mode = 'chat'; // 'chat' or 'search'
        chatModeBtn.onclick = () => {
            mode = 'chat';
            chatModeBtn.classList.add('active');
            searchModeBtn.classList.remove('active');
            userInput.placeholder = "Type your message...";
        };
        searchModeBtn.onclick = () => {
            mode = 'search';
            chatModeBtn.classList.remove('active');
            searchModeBtn.classList.add('active');
            userInput.placeholder = "Type your search query...";
        };

        let history = JSON.parse(localStorage.getItem('sigmaweb_claude_chat') || '[]');
        renderHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage('user', text);
            userInput.value = '';
            chatForm.querySelector('button').disabled = true;
            await aiReplyStream(text, history);
            chatForm.querySelector('button').disabled = false;
        });

        deleteHistoryBtn.onclick = function() {
            if (confirm("Delete all chat history?")) {
                localStorage.removeItem('sigmaweb_claude_chat');
                history = [];
                renderHistory();
            }
        };

        function addMessage(role, content) {
            history.push({ role, content });
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }

        // Markdown rendering (simple)
        function renderMarkdown(text) {
            text = escapeHtml(text);
            text = text.replace(/^###### (.*)$/gm, '<h6>$1</h6>')
                       .replace(/^##### (.*)$/gm, '<h5>$1</h5>')
                       .replace(/^#### (.*)$/gm, '<h4>$1</h4>')
                       .replace(/^### (.*)$/gm, '<h3>$1</h3>')
                       .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                       .replace(/^# (.*)$/gm, '<h1>$1</h1>');
            text = text.replace(/^[ \t]*[-*] (.*)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                       .replace(/\*(.*?)\*/g, '<i>$1</i>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/\[([^\]]+)\]\(([^ )]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            return text;
        }

        function renderMsgContent(content, streaming=false) {
            const codeBlockRegex = /```([a-zA-Z0-9]*)\s*([\s\S]*?)```/g;
            let lastIndex = 0;
            let htmlParts = [];
            let match;
            let isDesktop = window.innerWidth > 900;
            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    htmlParts.push(renderMarkdown(content.substring(lastIndex, match.index)));
                }
                const lang = match[1] || 'code';
                const code = match[2];
                htmlParts.push(
                    isDesktop
                    ? `<div class="code-card">
                        <span class="code-label">${escapeHtml(lang.toUpperCase())} CODE</span>
                        <div class="code-card-main">${escapeHtml(code)}</div>
                        <div class="code-card-buttons">
                            <button class="code-btn copy-btn" data-code="${encodeURIComponent(code)}">Copy</button>
                            <button class="code-btn run-btn" data-code="${encodeURIComponent(code)}" data-lang="${lang}">Run</button>
                        </div>
                    </div>`
                    : `<div class="code-label">${escapeHtml(lang.toUpperCase())} CODE</div><pre class="code-block">${escapeHtml(code)}</pre>`
                );
                lastIndex = codeBlockRegex.lastIndex;
            }
            if (lastIndex < content.length) {
                htmlParts.push(renderMarkdown(content.substring(lastIndex)));
            }
            let html = htmlParts.join('');
            if (streaming) html += `<span class="streaming"></span>`;
            return html;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderHistory(streamingIdx = -1, partial = "") {
            chatHistory.innerHTML = '';
            history.forEach((msg, idx) => {
                const div = document.createElement('div');
                div.className = 'msg ' + msg.role;
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                if (msg.role === 'ai') {
                    if (idx === streamingIdx) {
                        bubble.innerHTML = renderMsgContent(partial, true);
                    } else {
                        bubble.innerHTML = renderMsgContent(msg.content);
                    }
                } else {
                    bubble.textContent = msg.content;
                }
                div.appendChild(bubble);
                chatHistory.appendChild(div);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
            attachCodeBtns();
        }

        // Attach Copy/Run event listeners
        function attachCodeBtns() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.onclick = function() {
                    const code = decodeURIComponent(this.getAttribute('data-code'));
                    navigator.clipboard.writeText(code);
                    btn.textContent = "Copied!";
                    setTimeout(() => btn.textContent = "Copy", 1200);
                };
            });
            document.querySelectorAll('.run-btn').forEach(btn => {
                btn.onclick = function() {
                    const code = decodeURIComponent(this.getAttribute('data-code'));
                    const lang = (this.getAttribute('data-lang') || '').toLowerCase();
                    if (lang === 'html') {
                        const win = window.open();
                        win.document.write(code);
                    } else if (lang === 'js' || lang === 'javascript') {
                        try { eval(code); } catch(e) { alert("Error: " + e.message); }
                    } else {
                        alert("Run only supported for HTML and JS.");
                    }
                };
            });
        }

        // Live streaming: simulates streaming (replace with real Claude streaming if available)
        async function aiReplyStream(userMsg, historySnapshot) {
            addMessage('ai', '');
            let idx = history.length - 1;
            let fullText = '';
            const messages = [];
            historySnapshot.forEach(msg => {
                if (
                    (msg.role === 'user' || msg.role === 'ai') &&
                    msg.content && msg.content.trim() !== ""
                ) {
                    messages.push({
                        role: msg.role === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                }
            });
            messages.push({ role: 'user', content: userMsg });

            try {
                const keyResp = await fetch('/sigmaweb/api/claudeapi.txt');
                const apiKey = (await keyResp.text()).trim();
                const endpoint = 'https://api.anthropic.com/v1/messages';
                const model = mode === 'search' ? 'claude-opus-4-20250514' : 'claude-opus-4-20250514';
                // Simulated streaming: fetch all, animate
                const resp = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model,
                        max_tokens: 512,
                        messages
                    })
                });

                if (!resp.ok) {
                    let errorMsg = 'Claude API error.';
                    try {
                        const errorData = await resp.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg += ' ' + errorData.error.message;
                        }
                    } catch {}
                    updateAiMsg(idx, errorMsg);
                } else {
                    const data = await resp.json();
                    const aiText = data.content?.[0]?.text || 'No reply from Claude.';
                    for (let i = 0; i < aiText.length; i+=2) {
                        fullText = aiText.slice(0, i + 1);
                        renderHistory(idx, fullText);
                        await new Promise(res => setTimeout(res, 7));
                    }
                    updateAiMsg(idx, aiText);
                }
            } catch (err) {
                updateAiMsg(idx, 'Error contacting Claude API.');
            }
        }

        function updateAiMsg(idx, text) {
            history[idx].content = text;
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }
    </script>
</body>
</html>
