<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SigmaWeb AI Chat (Claude)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; }
        .chat-container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 24px; }
        .chat-history { height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 16px; background: #fafbfc; }
        .msg { margin-bottom: 14px; }
        .msg.user { text-align: right; }
        .msg.user .bubble { background: #007bff; color: #fff; }
        .msg.ai .bubble { background: #e9ecef; color: #222; }
        .bubble { display: inline-block; padding: 10px 16px; border-radius: 18px; max-width: 80%; white-space: pre-wrap; word-break: break-word; }
        .input-row { display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; background: #007bff; color: #fff; font-size: 16px; cursor: pointer; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .logo { text-align: center; margin-bottom: 18px; }
        .logo span { font-weight: bold; font-size: 1.3em; color: #007bff; }
        /* Code styling */
        pre.code-block {
            background: #222;
            color: #eee;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 15px;
            line-height: 1.5;
            overflow-x: auto;
            border: 1px solid #333;
        }
        .code-label {
            display: inline-block;
            font-size: 13px;
            color: #007bff;
            background: #e9ecef;
            border-radius: 5px;
            padding: 2px 8px;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="logo"><span>SigmaWeb AI Chat (Claude)</span></div>
        <div id="chatHistory" class="chat-history"></div>
        <form id="chatForm" class="input-row" autocomplete="off">
            <input type="text" id="userInput" placeholder="Type your message..." required autofocus />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');

        // Load chat history from localStorage
        let history = JSON.parse(localStorage.getItem('sigmaweb_claude_chat') || '[]');
        renderHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage('user', text);
            userInput.value = '';
            chatForm.querySelector('button').disabled = true;

            // Use Claude API via backend endpoint
            const aiReply = await getClaudeReply(text, history);

            addMessage('ai', aiReply);
            chatForm.querySelector('button').disabled = false;
        });

        function addMessage(role, content) {
            history.push({ role, content });
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }

        // --- THIS IS THE KEY FUNCTION ---
        function renderMsgContent(content) {
            // Regex for code block: ```language\n...\n```
            const codeBlockRegex = /```([a-zA-Z0-9]*)\s*([\s\S]*?)```/g;
            let lastIndex = 0;
            let htmlParts = [];
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                // Add text before code block
                if (match.index > lastIndex) {
                    htmlParts.push(escapeHtml(content.substring(lastIndex, match.index)));
                }
                // Add code block
                const lang = match[1] || 'code';
                const code = match[2];
                htmlParts.push(
                    `<div class="code-label">${escapeHtml(lang.toUpperCase())} CODE</div><pre class="code-block">${escapeHtml(code)}</pre>`
                );
                lastIndex = codeBlockRegex.lastIndex;
            }
            // Add remaining text after last code block
            if (lastIndex < content.length) {
                htmlParts.push(escapeHtml(content.substring(lastIndex)));
            }

            return htmlParts.join('');
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderHistory() {
            chatHistory.innerHTML = '';
            history.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg ' + msg.role;
                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                if (msg.role === 'ai') {
                    bubble.innerHTML = renderMsgContent(msg.content);
                } else {
                    bubble.textContent = msg.content;
                }
                div.appendChild(bubble);
                chatHistory.appendChild(div);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Claude API call using backend endpoint and haiku-3.5 model
        async function getClaudeReply(userMsg, history) {
            try {
                // Prepare messages for Claude API (must be array of {role, content})
                const messages = [];
                // Only push user/assistant roles, skip others
                history.forEach(msg => {
                    if (msg.role === 'user' || msg.role === 'ai') {
                        messages.push({
                            role: msg.role === 'user' ? 'user' : 'assistant',
                            content: msg.content
                        });
                    }
                });
                // Always end with the latest user message
                messages.push({ role: 'user', content: userMsg });

                // Fetch API key from /api/claudeapi.txt
                const keyResp = await fetch('/sigmaweb/api/claudeapi.txt');
                const apiKey = (await keyResp.text()).trim();

                // Claude API endpoint and model
                const endpoint = 'https://api.anthropic.com/v1/messages';
                const model = 'claude-opus-4-20250514';

                // Send request to Claude API
                const resp = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model,
                        max_tokens: 512,
                        messages
                    })
                });

                // Improved error handling
                if (!resp.ok) {
                    let errorMsg = 'Claude API error.';
                    try {
                        const errorData = await resp.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg += ' ' + errorData.error.message;
                        }
                    } catch {}
                    return errorMsg;
                }
                const data = await resp.json();
                // Claude API returns content as array of objects with 'text'
                return data.content?.[0]?.text || 'No reply from Claude.';
            } catch (err) {
                return 'Error contacting Claude API.';
            }
        }
    </script>
</body>
</html>
