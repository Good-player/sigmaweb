<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SigmaWeb AI Chat (Claude)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; }
        .chat-container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 24px; }
        .chat-history { height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 16px; background: #fafbfc; }
        .msg { margin-bottom: 14px; display: flex; }
        .msg.user { justify-content: flex-end; }
        .msg.ai { justify-content: flex-start; }
        .msg .bubble { display: inline-block; padding: 10px 16px; border-radius: 18px; max-width: 80%; background: #e9ecef; color: #222; white-space: pre-wrap; word-break: break-word; }
        .msg.user .bubble { background: #007bff; color: #fff; }
        .code-card {
            background: #222;
            color: #eee;
            border-radius: 12px;
            margin: 8px 0;
            font-size: 15px;
            overflow-x: auto;
            border: 1px solid #333;
            box-shadow: 0 2px 8px #bbb;
            padding: 0;
            position: relative;
            max-width: 340px;
            min-width: 240px;
            margin-left: 12px;
        }
        .code-card-main { padding: 18px 14px 12px 16px; font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace; }
        .code-card-buttons {
            position: absolute;
            top: 8px;
            right: 12px;
            display: flex;
            gap: 6px;
        }
        .code-label {
            display: block;
            font-size: 13px;
            color: #007bff;
            background: #e9ecef;
            border-radius: 5px;
            padding: 2px 8px;
            margin-bottom: 3px;
            margin-left: 16px;
            margin-top: 10px;
            width: fit-content;
        }
        .code-btn {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            padding: 2px 8px;
            cursor: pointer;
        }
        .code-btn:active { background: #005bb5; }
        .input-row { display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; background: #007bff; color: #fff; font-size: 16px; cursor: pointer; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .logo { text-align: center; margin-bottom: 18px; }
        .logo span { font-weight: bold; font-size: 1.3em; color: #007bff; }
        .history-btn-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .mode-switch { margin-left: auto; }
        .mode-btn { background: #e9ecef; color: #007bff; border: none; border-radius: 5px; font-size: 14px; padding: 6px 13px; cursor: pointer; margin-left: 5px; }
        .mode-btn.active { background: #007bff; color: #fff; }
        @media (max-width: 700px) {
            .chat-container { max-width: 98vw; }
            .code-card { max-width: 99vw; min-width: 0; margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="logo"><span>SigmaWeb AI Chat (Claude)</span></div>
        <div class="history-btn-row">
            <button id="deleteHistoryBtn" title="Delete chat history" style="background:#f44336; color:white;">Delete history</button>
            <div class="mode-switch">
                <button class="mode-btn active" id="chatModeBtn">Chat</button>
                <button class="mode-btn" id="searchModeBtn">Search</button>
            </div>
        </div>
        <div id="chatHistory" class="chat-history"></div>
        <form id="chatForm" class="input-row" autocomplete="off">
            <input type="text" id="userInput" placeholder="Type your message..." required autofocus />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
        const chatModeBtn = document.getElementById('chatModeBtn');
        const searchModeBtn = document.getElementById('searchModeBtn');

        let mode = 'chat'; // 'chat' or 'search'

        chatModeBtn.onclick = () => {
            mode = 'chat';
            chatModeBtn.classList.add('active');
            searchModeBtn.classList.remove('active');
            userInput.placeholder = "Type your message...";
        };
        searchModeBtn.onclick = () => {
            mode = 'search';
            chatModeBtn.classList.remove('active');
            searchModeBtn.classList.add('active');
            userInput.placeholder = "Type your search query...";
        };

        // Load chat history from localStorage
        let history = JSON.parse(localStorage.getItem('sigmaweb_claude_chat') || '[]');
        renderHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage('user', text);
            userInput.value = '';
            chatForm.querySelector('button').disabled = true;

            // Use Claude API via backend endpoint
            // live talking: stream the response
            await aiReplyStream(text, history);

            chatForm.querySelector('button').disabled = false;
        });

        deleteHistoryBtn.onclick = function() {
            if (confirm("Delete all chat history?")) {
                localStorage.removeItem('sigmaweb_claude_chat');
                history = [];
                renderHistory();
            }
        };

        function addMessage(role, content) {
            history.push({ role, content });
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }

        // Markdown parser (simple, handles bold, italics, lists, links, inline code, headings)
        function renderMarkdown(text) {
            // Escape html
            text = escapeHtml(text);

            // Headings
            text = text.replace(/^###### (.*)$/gm, '<h6>$1</h6>')
                       .replace(/^##### (.*)$/gm, '<h5>$1</h5>')
                       .replace(/^#### (.*)$/gm, '<h4>$1</h4>')
                       .replace(/^### (.*)$/gm, '<h3>$1</h3>')
                       .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                       .replace(/^# (.*)$/gm, '<h1>$1</h1>');

            // Lists
            text = text.replace(/^\s*[-*] (.*)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');

            // Bold and italics
            text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                       .replace(/\*(.*?)\*/g, '<i>$1</i>');

            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Links
            text = text.replace(/\[([^\]]+)\]\(([^ )]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            return text;
        }

        // Detect code blocks and render markdown
        function renderMsgContent(content) {
            // Regex for code block: ```language\n...\n```
            const codeBlockRegex = /```([a-zA-Z0-9]*)\s*([\s\S]*?)```/g;
            let lastIndex = 0;
            let htmlParts = [];
            let match;

            let isDesktop = window.innerWidth > 700;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                // Add markdown before code block
                if (match.index > lastIndex) {
                    htmlParts.push(renderMarkdown(content.substring(lastIndex, match.index)));
                }
                // Add code block
                const lang = match[1] || 'code';
                const code = match[2];

                // Claude-style code card (desktop only)
                htmlParts.push(
                    isDesktop
                    ? `<div class="code-card">
                        <span class="code-label">${escapeHtml(lang.toUpperCase())} CODE</span>
                        <div class="code-card-main">${escapeHtml(code)}</div>
                        <div class="code-card-buttons">
                            <button class="code-btn copy-btn" data-code="${encodeURIComponent(code)}">Copy</button>
                            <button class="code-btn run-btn" data-code="${encodeURIComponent(code)}" data-lang="${lang}">Run</button>
                        </div>
                    </div>`
                    // On mobile, just show regular code block
                    : `<div class="code-label">${escapeHtml(lang.toUpperCase())} CODE</div><pre class="code-block">${escapeHtml(code)}</pre>`
                );
                lastIndex = codeBlockRegex.lastIndex;
            }
            // Add markdown after last code block
            if (lastIndex < content.length) {
                htmlParts.push(renderMarkdown(content.substring(lastIndex)));
            }
            return htmlParts.join('');
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderHistory() {
            chatHistory.innerHTML = '';
            history.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg ' + msg.role;
                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                if (msg.role === 'ai') {
                    bubble.innerHTML = renderMsgContent(msg.content);
                } else {
                    bubble.textContent = msg.content;
                }
                div.appendChild(bubble);
                chatHistory.appendChild(div);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
            attachCodeBtns();
        }

        // Attach Copy/Run event listeners (re-run after render)
        function attachCodeBtns() {
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.onclick = function() {
                    const code = decodeURIComponent(this.getAttribute('data-code'));
                    navigator.clipboard.writeText(code);
                    btn.textContent = "Copied!";
                    setTimeout(() => btn.textContent = "Copy", 1200);
                };
            });
            document.querySelectorAll('.run-btn').forEach(btn => {
                btn.onclick = function() {
                    const code = decodeURIComponent(this.getAttribute('data-code'));
                    const lang = (this.getAttribute('data-lang') || '').toLowerCase();
                    if (lang === 'html') {
                        // Open in new window if HTML
                        const win = window.open();
                        win.document.write(code);
                    } else if (lang === 'js' || lang === 'javascript') {
                        try { eval(code); } catch(e) { alert("Error: " + e.message); }
                    } else {
                        alert("Run only supported for HTML and JS.");
                    }
                };
            });
        }

        // Live talking/typing
        async function aiReplyStream(userMsg, historySnapshot) {
            addMessage('ai', ''); // Add empty AI message for typing
            let idx = history.length - 1;
            let fullText = '';
            let lastUpdate = 0;
            let streamFinished = false;

            // Backend streaming endpoint (simulate with polling for demo)
            // Replace with your actual streaming API if available!
            // Here, we fetch Claude's response and type it out character by character.
            try {
                // Prepare messages for Claude API
                const messages = [];
                historySnapshot.forEach(msg => {
                    if (msg.role === 'user' || msg.role === 'ai') {
                        messages.push({
                            role: msg.role === 'user' ? 'user' : 'assistant',
                            content: msg.content
                        });
                    }
                });
                messages.push({ role: 'user', content: userMsg });

                // Get API key
                const keyResp = await fetch('/sigmaweb/api/claudeapi.txt');
                const apiKey = (await keyResp.text()).trim();

                // Claude API endpoint and model
                const endpoint = 'https://api.anthropic.com/v1/messages';
                const model = mode === 'search' ? 'claude-opus-4-20250514' : 'claude-opus-4-20250514';

                const resp = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model,
                        max_tokens: 512,
                        messages
                    })
                });

                if (!resp.ok) {
                    let errorMsg = 'Claude API error.';
                    try {
                        const errorData = await resp.json();
                        if (errorData.error && errorData.error.message) {
                            errorMsg += ' ' + errorData.error.message;
                        }
                    } catch {}
                    updateAiMsg(idx, errorMsg);
                    streamFinished = true;
                } else {
                    const data = await resp.json();
                    const aiText = data.content?.[0]?.text || 'No reply from Claude.';
                    for (let i = 0; i < aiText.length; i++) {
                        fullText = aiText.slice(0, i + 1);
                        updateAiMsg(idx, fullText);
                        await new Promise(res => setTimeout(res, 7)); // typing speed
                    }
                    // Final update
                    updateAiMsg(idx, aiText);
                    streamFinished = true;
                }
            } catch (err) {
                updateAiMsg(idx, 'Error contacting Claude API.');
                streamFinished = true;
            }
        }

        function updateAiMsg(idx, text) {
            history[idx].content = text;
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }
    </script>
</body>
</html>
