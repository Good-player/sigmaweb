<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SigmaWeb AI Chat (Claude)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; }
        .chat-container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 24px; }
        .chat-history { height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 16px; background: #fafbfc; }
        .msg { margin-bottom: 14px; }
        .msg.user { text-align: right; }
        .msg.user .bubble { background: #007bff; color: #fff; }
        .msg.ai .bubble { background: #e9ecef; color: #222; }
        .bubble { display: inline-block; padding: 10px 16px; border-radius: 18px; max-width: 80%; }
        .input-row { display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; background: #007bff; color: #fff; font-size: 16px; cursor: pointer; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .logo { text-align: center; margin-bottom: 18px; }
        .logo span { font-weight: bold; font-size: 1.3em; color: #007bff; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="logo"><span>SigmaWeb AI Chat (Claude)</span></div>
        <div id="chatHistory" class="chat-history"></div>
        <form id="chatForm" class="input-row" autocomplete="off">
            <input type="text" id="userInput" placeholder="Type your message..." required autofocus />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');

        // Load chat history from localStorage
        let history = JSON.parse(localStorage.getItem('sigmaweb_claude_chat') || '[]');
        renderHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage('user', text);
            userInput.value = '';
            chatForm.querySelector('button').disabled = true;

            // Use Claude API via backend endpoint
            const aiReply = await getClaudeReply(text, history);

            addMessage('ai', aiReply);
            chatForm.querySelector('button').disabled = false;
        });

        function addMessage(role, content) {
            history.push({ role, content });
            localStorage.setItem('sigmaweb_claude_chat', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            chatHistory.innerHTML = '';
            history.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg ' + msg.role;
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = msg.content;
                div.appendChild(bubble);
                chatHistory.appendChild(div);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Claude API call using backend endpoint and haiku-3.5 model
        async function getClaudeReply(userMsg, history) {
            try {
                // Prepare messages for Claude API
                const messages = history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.content
                }));
                messages.push({ role: 'user', content: userMsg });

                // Fetch API key from /api/claudeapi.txt
                const keyResp = await fetch('/sigmaweb/api/claudeapi.txt');
                const apiKey = (await keyResp.text()).trim();

                // Claude API endpoint and model
                const endpoint = 'https://api.anthropic.com/v1/messages';
                const model = 'claude-3.5-haiku-20240229';

                // Send request to Claude API
                const resp = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model,
                        max_tokens: 512,
                        messages
                    })
                });

                if (!resp.ok) throw new Error('Claude API error');
                const data = await resp.json();
                return data.content?.[0]?.text || 'No reply from Claude.';
            } catch (err) {
                return 'Error contacting Claude API.';
            }
        }
    </script>
</body>
</html>
